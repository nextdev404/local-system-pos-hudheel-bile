<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Hudheel-Bile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link rel="icon" href="./Gemini_Generated_Image_kzm9l5kzm9l5kzm9.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <!-- Adds the Walkie-Talkie -->
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#10B981",
              "primary-dark": "#059669",
              "primary-light": "#D1FAE5",
              surface: "#F3F4F6",
              sidebar: "#1F1D2B", // Legacy
              "sidebar-active": "#EA7C69", // Legacy
            },
            fontFamily: {
              sans: ['"Plus Jakarta Sans"', "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }

      .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }

        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      .animate-slide-up {
        animation: slideUp 0.3s ease-out forwards;
      }

      .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }

      .active-table-card {
        border-color: #10b981;
        background-color: #ecfdf5;
      }

      .dark .active-table-card {
        background-color: rgba(16, 185, 129, 0.1);
        border-color: #10b981;
      }

      /* Mobile Cart Transitions */
      .cart-mobile-hidden {
        transform: translateX(100%);
      }

      .cart-mobile-visible {
        transform: translateX(0);
      }

      /* Sidebar Transitions */
      .sidebar-mobile-hidden {
        transform: translateX(-100%);
      }

      .sidebar-mobile-visible {
        transform: translateX(0);
      }
    </style>
    <!-- NEW: Instantly checks dark mode before the screen paints -->
    <script>
      if (localStorage.getItem("hudheele_dark_mode") === "1") {
        document.documentElement.classList.add("dark");
      }
    </script>
  </head>

  <body
    class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 h-screen w-screen overflow-hidden selection:bg-primary-light selection:text-primary-dark transition-colors duration-300"
  >
    <!-- LOGIN SCREEN (Overlay) -->
    <div
      id="login-screen"
      class="fixed inset-0 z-50 bg-gray-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white w-full max-w-4xl rounded-[2rem] shadow-2xl overflow-hidden flex flex-col md:flex-row animate-slide-up max-h-screen md:h-[600px] overflow-y-auto md:overflow-hidden"
      >
        <!-- Left Side Image -->
        <div
          class="w-full md:w-1/2 bg-primary relative hidden md:block overflow-hidden h-48 md:h-full flex-shrink-0"
        >
          <img
            src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=1000&auto=format&fit=crop"
            class="absolute inset-0 w-full h-full object-cover opacity-80 mix-blend-multiply"
          />
          <div
            class="absolute inset-0 flex flex-col items-center justify-center text-white p-8 md:p-12 text-center"
          >
            <div
              class="w-16 h-16 md:w-20 md:h-20 bg-white/20 rounded-full flex items-center justify-center text-white text-3xl md:text-4xl mb-4 md:mb-6 backdrop-blur-md border border-white/30"
            >
              <i class="fa-solid fa-leaf"></i>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold mb-2 md:mb-4">
              Hudheel-Bile
            </h1>
            <p class="text-primary-light text-base md:text-lg">
              Fresh Food, Fast Service.
            </p>
          </div>
        </div>

        <!-- Right Side Login -->
        <div
          class="w-full md:w-1/2 p-6 sm:p-8 md:p-12 flex flex-col justify-center"
        >
          <div class="mb-6 md:mb-8 text-center md:text-left">
            <h2 class="text-2xl font-bold text-gray-800">Welcome Back</h2>
            <p class="text-gray-400">Please select your role to continue</p>
          </div>

          <div class="space-y-4 md:space-y-6">
            <!-- Role Selection -->
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4">
              <button
                type="button"
                onclick="selectLoginRole(this.dataset.role)"
                class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                data-role="Admin"
              >
                <div
                  class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base pointer-events-none"
                >
                  <i class="fa-solid fa-user-tie"></i>
                </div>
                <span
                  class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark pointer-events-none"
                  >Admin</span
                >
              </button>
              <button
                type="button"
                onclick="selectLoginRole(this.dataset.role)"
                class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                data-role="Waiter"
              >
                <div
                  class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base pointer-events-none"
                >
                  <i class="fa-solid fa-bell-concierge"></i>
                </div>
                <span
                  class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark pointer-events-none"
                  >Waiter</span
                >
              </button>
              <button
                type="button"
                onclick="selectLoginRole(this.dataset.role)"
                class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                data-role="Chef"
              >
                <div
                  class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base pointer-events-none"
                >
                  <i class="fa-solid fa-fire-burner"></i>
                </div>
                <span
                  class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark pointer-events-none"
                  >Chef</span
                >
              </button>
              <button
                type="button"
                onclick="selectLoginRole(this.dataset.role)"
                class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                data-role="Manager"
              >
                <div
                  class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base pointer-events-none"
                >
                  <i class="fa-solid fa-briefcase"></i>
                </div>
                <span
                  class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark pointer-events-none"
                  >Manager</span
                >
              </button>
              <button
                type="button"
                onclick="selectLoginRole(this.dataset.role)"
                class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                data-role="Cashier"
              >
                <div
                  class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base pointer-events-none"
                >
                  <i class="fa-solid fa-cash-register"></i>
                </div>
                <span
                  class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark pointer-events-none"
                  >Cashier</span
                >
              </button>
            </div>

            <!-- User Selection -->
            <div id="user-selection-container" class="hidden animate-fade-in">
              <label class="block text-sm font-bold text-gray-700 mb-2 pl-1"
                >Select User Account</label
              >
              <div class="relative">
                <select
                  id="login-user-select"
                  class="w-full bg-white border border-gray-200 rounded-xl py-3 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-primary appearance-none font-medium text-gray-700 cursor-pointer shadow-sm"
                >
                  <!-- Options injected by JS -->
                </select>
                <i
                  class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
                ></i>
              </div>
            </div>

            <!-- PIN Input -->
            <div class="relative">
              <i
                class="fa-solid fa-lock absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"
              ></i>
              <input
                type="password"
                id="login-pin"
                placeholder="Type Your Pin"
                class="w-full bg-gray-50 border border-gray-200 rounded-xl py-4 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-primary transition-all font-mono text-lg tracking-widest text-center shadow-inner text-gray-800"
              />
            </div>

            <button
              onclick="handleLogin()"
              class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30 transition-all active:scale-95 flex items-center justify-center gap-2"
            >
              <span>Login</span>
              <i class="fa-solid fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div
      id="sidebar-overlay"
      onclick="toggleSidebar()"
      class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden backdrop-blur-sm transition-opacity"
    ></div>

    <!-- MAIN APP CONTAINER -->
    <div
      id="app-container"
      class="flex h-screen hidden bg-[#F8F9FD] dark:bg-gray-900 transition-colors duration-300"
    >
      <!-- SIDEBAR -->
      <aside
        id="main-sidebar"
        class="sidebar-mobile-hidden lg:sidebar-mobile-visible fixed inset-y-0 left-0 z-[60] w-64 bg-white dark:bg-gray-800 flex flex-col py-6 px-4 lg:m-4 rounded-r-[2rem] lg:rounded-[2rem] shadow-2xl lg:shadow-sm flex-shrink-0 transition-transform duration-300 ease-in-out lg:static lg:transform-none"
      >
        <!-- Logo -->
        <div class="flex items-center gap-3 px-4 mb-10">
          <div
            class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary text-xl shadow-sm"
          >
            <i class="fa-solid fa-leaf"></i>
          </div>
          <div>
            <h1
              class="font-bold text-lg leading-tight text-gray-800 dark:text-white"
            >
              Hudheel<br />Bile Pro
            </h1>
          </div>
          <!-- Close Button Mobile -->
          <button
            onclick="toggleSidebar()"
            class="ml-auto lg:hidden text-gray-400 hover:text-gray-600"
          >
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>

        <!-- Navigation -->
        <nav
          class="flex flex-col gap-2 md:gap-3 w-full flex-1 overflow-y-auto hide-scrollbar"
          id="nav-menu"
        >
          <!-- Nav items injected by JS -->
        </nav>

        <!-- Bottom Section (Settings, User, Logout) -->
        <div
          class="mt-auto pt-4 border-t border-gray-100 dark:border-gray-700 flex flex-col gap-2"
        >
          <!-- Settings Button -->
          <button
            onclick="switchView('settings')"
            data-view="settings"
            id="settings-btn"
            class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-500 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-all font-medium group hidden"
          >
            <div
              class="w-10 h-10 rounded-xl flex items-center justify-center text-xl transition-colors icon-container"
            >
              <i class="fa-solid fa-gear"></i>
            </div>
            <span data-i18n="nav_settings">Settings</span>
          </button>

          <!-- User Profile -->
          <div
            class="flex items-center gap-3 p-3 rounded-2xl bg-gray-50 dark:bg-gray-700 cursor:pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors mt-2"
          >
            <img
              src="https://ui-avatars.com/api/?name=User&background=10B981&color=fff"
              id="user-avatar"
              class="w-10 h-10 rounded-full object-cover"
            />
            <div class="flex-1 min-w-0">
              <h4
                class="text-sm font-bold text-gray-800 dark:text-white truncate"
                id="user-name-display"
              >
                User Name
              </h4>
              <p
                class="text-xs text-gray-400 dark:text-gray-300 truncate"
                id="user-role-label"
              >
                Role
              </p>
            </div>
          </div>

          <!-- Dark Mode + Language â€” Unified Control Row -->
          <div
            class="mx-1 mb-1 flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/60 rounded-2xl border border-gray-100 dark:border-gray-700"
          >
            <!-- Dark Mode Toggle -->
            <button
              onclick="toggleDarkMode()"
              id="dark-mode-toggle-sidebar"
              class="flex-1 flex items-center justify-center gap-1.5 py-2 rounded-xl transition-all hover:bg-gray-100 dark:hover:bg-gray-600 group"
              title="Toggle Dark Mode"
            >
              <div
                class="w-7 h-7 rounded-lg bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center transition-colors"
              >
                <i
                  id="dark-mode-icon"
                  class="fa-solid fa-moon text-xs text-gray-500 dark:text-amber-400"
                ></i>
              </div>
              <span class="text-xs font-bold text-gray-500 dark:text-gray-300"
                >Dark</span
              >
            </button>

            <!-- Divider -->
            <div
              class="w-px h-6 bg-gray-200 dark:bg-gray-600 flex-shrink-0"
            ></div>

            <!-- Language Toggle -->
            <div
              class="flex-1 flex gap-1 p-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm"
            >
              <button
                id="lang-btn-en"
                onclick="setLanguage('en')"
                class="flex-1 py-1.5 text-xs font-extrabold rounded-lg bg-primary text-white transition-all shadow-sm"
              >
                EN
              </button>
              <button
                id="lang-btn-so"
                onclick="setLanguage('so')"
                class="flex-1 py-1.5 text-xs font-extrabold rounded-lg text-gray-400 dark:text-gray-400 hover:text-gray-700 transition-all"
              >
                SO
              </button>
            </div>
          </div>

          <!-- Logout Button -->
          <button
            onclick="logout()"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-500 dark:text-gray-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all font-medium group"
            id="logout-btn"
          >
            <div
              class="w-10 h-10 rounded-xl flex items-center justify-center text-xl transition-colors"
            >
              <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </div>
            <span data-i18n="nav_logout">Logout</span>
          </button>
        </div>
      </aside>

      <!-- CONTENT AREA -->
      <div
        class="flex-1 flex gap-4 py-4 pr-4 lg:pl-0 pl-4 h-full overflow-hidden relative"
        id="main-content"
      >
        <!-- POS VIEW -->
        <div
          id="view-pos"
          class="flex-1 flex flex-col lg:flex-row gap-4 h-full w-full"
        >
          <!-- CENTER: Menu & Categories -->
          <main class="flex-1 flex flex-col h-full min-w-0">
            <!-- Top Bar -->
            <header
              class="flex items-center justify-between mb-4 lg:mb-6 flex-shrink-0"
            >
              <button
                onclick="toggleSidebar()"
                class="p-3 bg-white dark:bg-gray-800 rounded-xl text-gray-400 hover:text-gray-800 dark:hover:text-white shadow-sm lg:hidden mr-3"
              >
                <i class="fa-solid fa-bars"></i>
              </button>

              <div
                class="flex-1 bg-white dark:bg-gray-800 rounded-2xl shadow-sm flex items-center px-3 py-2.5 md:px-4 md:py-3 transition-colors duration-300 mr-1.5 md:mr-4"
              >
                <i
                  class="fa-solid fa-search text-gray-400 mr-2 md:mr-3 text-sm"
                ></i>
                <input
                  type="text"
                  id="search-input"
                  placeholder="Search Product..."
                  oninput="renderMenu()"
                  class="flex-1 bg-transparent focus:outline-none text-xs md:text-sm font-medium text-gray-700 dark:text-gray-200 placeholder-gray-400 w-full min-w-0"
                />
              </div>

              <!-- Admin Add Product Button -->
              <div class="flex gap-2 flex-shrink-0">
                <button
                  id="add-product-btn"
                  onclick="openAddProductModal()"
                  class="hidden w-11 h-11 md:w-12 md:h-12 bg-primary text-white rounded-2xl shadow-sm flex items-center justify-center hover:bg-primary-dark transition-colors shadow-lg shadow-primary/30"
                >
                  <i class="fa-solid fa-plus"></i>
                </button>
              </div>
            </header>

            <!-- Scrollable Area -->
            <div
              class="flex-1 overflow-y-auto hide-scrollbar pb-24 lg:pb-20 relative"
            >
              <!-- Categories -->
              <div
                class="flex gap-3 lg:gap-4 mb-6 overflow-x-auto hide-scrollbar pb-2"
                id="category-container"
              >
                <!-- Injected JS -->
              </div>

              <!-- Menu Grid -->
              <div
                class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-3 gap-3 lg:gap-5"
                id="menu-container"
              >
                <!-- Injected JS -->
              </div>
            </div>
          </main>

          <!-- RIGHT: Cart Panel (Responsive) -->
          <aside
            id="pos-cart-panel"
            class="fixed inset-0 z-50 lg:z-0 w-full lg:w-[400px] lg:static bg-white dark:bg-gray-800 rounded-none lg:rounded-[2rem] shadow-2xl lg:shadow-sm flex flex-col h-full overflow-y-auto hide-scrollbar transition-transform duration-300 ease-in-out cart-mobile-hidden lg:transform-none lg:block"
          >
            <!-- Mobile Header for Cart -->
            <div
              class="sticky top-0 z-20 lg:hidden p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white/95 backdrop-blur-sm dark:bg-gray-800/95"
            >
              <h2
                class="text-xl font-bold text-gray-800 dark:text-white"
                data-i18n="current_order"
              >
                Current Order
              </h2>
              <div class="flex items-center gap-2">
                <button
                  id="release-table-btn-mobile"
                  onclick="requestReleaseTable()"
                  class="hidden items-center gap-2 px-3 py-2 rounded-xl border-2 border-red-200 bg-red-50 dark:bg-red-900/20 dark:border-red-800 text-red-500 dark:text-red-400 hover:bg-red-500 hover:border-red-500 hover:text-white dark:hover:bg-red-600 dark:hover:border-red-600 transition-all text-xs font-bold shadow-sm active:scale-95"
                  title="Release this table"
                >
                  <i class="fa-solid fa-door-open text-sm"></i>
                  <span data-i18n="btn_release">Release</span>
                </button>
                <button
                  onclick="toggleMobileCart()"
                  class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500"
                >
                  <i class="fa-solid fa-chevron-down"></i>
                </button>
              </div>
            </div>

            <!-- Header -->
            <div class="p-6 pb-2 hidden lg:block">
              <div class="flex justify-between items-start mb-6">
                <div>
                  <h2
                    class="text-2xl font-bold text-gray-800 dark:text-white"
                    id="cart-table-name"
                  >
                    Table 4
                  </h2>
                  <p
                    class="text-sm font-medium text-gray-400 dark:text-gray-500 mt-0.5"
                    id="cart-customer-name"
                  >
                    Floyd Miles
                  </p>
                  <span
                    id="cart-status-badge"
                    class="mt-2 inline-block px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-600"
                    >Occupied</span
                  >
                </div>
                <button
                  id="release-table-btn"
                  onclick="requestReleaseTable()"
                  class="hidden items-center gap-2 px-3 py-2 rounded-xl border-2 border-red-200 bg-red-50 dark:bg-red-900/20 dark:border-red-800 text-red-500 dark:text-red-400 hover:bg-red-500 hover:border-red-500 hover:text-white dark:hover:bg-red-600 dark:hover:border-red-600 transition-all text-xs font-bold shadow-sm active:scale-95"
                  title="Release this table"
                >
                  <i class="fa-solid fa-door-open text-sm"></i>
                  <span data-i18n="btn_release">Release</span>
                </button>
              </div>
            </div>

            <!-- Order Type Tabs (Visible on mobile within cart) -->
            <div class="px-6 lg:px-6 pt-2 pb-2">
              <div
                class="flex bg-gray-100 dark:bg-gray-700 p-1.5 rounded-2xl mb-4"
              >
                <button
                  class="flex-1 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-sm bg-primary text-white order-type-btn"
                  data-type="Dine In"
                  data-i18n="dine_in"
                >
                  Customer Order
                </button>
              </div>
            </div>

            <!-- Cart List -->
            <div class="flex-1 px-6 pb-24 space-y-4" id="cart-container">
              <!-- Injected JS -->
            </div>

            <!-- Footer (Sticky Floating Button Area) -->
            <div
              class="sticky bottom-0 z-20 p-6 bg-white/95 backdrop-blur-md dark:bg-gray-800/95 border-t border-gray-100 dark:border-gray-700 pb-8 sm:pb-6 rounded-b-none lg:rounded-b-[2rem]"
            >
              <div class="space-y-3 mb-6 hidden lg:block">
                <div
                  class="flex justify-between text-gray-500 dark:text-gray-400 text-sm"
                >
                  <span data-i18n="sub_total">Sub Total</span>
                  <span
                    class="font-bold text-gray-800 dark:text-white"
                    id="subtotal-display"
                    >$0.00</span
                  >
                </div>
                <div
                  class="flex justify-between text-gray-500 dark:text-gray-400 text-sm"
                >
                  <span data-i18n="tax">Tax 5%</span>
                  <span
                    class="font-bold text-gray-800 dark:text-white"
                    id="tax-display"
                    >$0.00</span
                  >
                </div>
                <div
                  class="my-3 border-t border-dashed border-gray-200 dark:border-gray-700"
                ></div>
                <div class="flex justify-between items-center">
                  <span
                    class="text-lg font-bold text-gray-800 dark:text-white"
                    data-i18n="total_amount"
                    >Total Amount</span
                  >
                  <span
                    class="text-2xl font-bold text-gray-800 dark:text-white"
                    id="total-display"
                    >$0.00</span
                  >
                </div>
              </div>

              <div class="flex justify-between items-center lg:hidden mb-4">
                <span
                  class="text-lg font-bold text-gray-800 dark:text-white"
                  data-i18n="total_amount"
                  >Total Amount</span
                >
                <span
                  class="text-2xl font-bold text-gray-800 dark:text-white"
                  id="total-display-mobile"
                  >$0.00</span
                >
              </div>

              <!-- Payment Methods -->
              <div
                class="flex gap-2 sm:gap-3 mb-6"
                id="payment-methods-container"
              >
                <!-- Cash -->
                <button
                  onclick="setPaymentMethod('Cash')"
                  id="pay-cash"
                  class="payment-btn flex-1 py-3 px-2 rounded-xl border-2 border-primary bg-primary/5 text-primary flex flex-col items-center justify-center gap-1.5 transition-all shadow-sm"
                >
                  <i class="fa-solid fa-money-bill text-lg"></i>
                  <span
                    class="text-[10px] font-bold uppercase tracking-wide"
                    data-i18n="pay_cash"
                    >Cash</span
                  >
                </button>

                <!-- Zaad -->
                <button
                  onclick="setPaymentMethod('Zaad')"
                  id="pay-zaad"
                  class="payment-btn flex-1 py-3 px-2 rounded-xl border-2 border-gray-200 dark:border-gray-600 text-gray-400 hover:border-[#4caf50] hover:text-[#4caf50] hover:bg-green-50 dark:hover:bg-green-900/20 flex flex-col items-center justify-center gap-1 transition-all"
                >
                  <i class="fa-solid fa-mobile-screen-button text-lg"></i>
                  <span
                    class="text-[10px] font-bold uppercase tracking-wide"
                    data-i18n="pay_card"
                    >Zaad</span
                  >
                </button>

                <!-- E-dahab -->
                <button
                  onclick="setPaymentMethod('E-dahab')"
                  id="pay-e-dahab"
                  class="payment-btn flex-1 py-3 px-2 rounded-xl border-2 border-gray-200 dark:border-gray-600 text-gray-400 hover:border-orange-400 hover:text-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/20 flex flex-col items-center justify-center gap-1 transition-all"
                >
                  <i class="fa-solid fa-mobile-screen-button text-lg"></i>
                  <span
                    class="text-[10px] font-bold uppercase tracking-wide"
                    data-i18n="pay_qr"
                    >E-dahab</span
                  >
                </button>
              </div>

              <button
                id="main-action-btn"
                onclick="handleMainAction()"
                class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl shadow-xl shadow-primary/30 transition-all active:scale-95 text-sm uppercase tracking-wide"
                data-i18n="send_to_kitchen"
              >
                Send to Kitchen
              </button>
            </div>
          </aside>

          <!-- Mobile Floating Cart Button -->
          <button
            onclick="toggleMobileCart()"
            id="mobile-cart-btn"
            class="lg:hidden fixed bottom-6 right-6 left-6 bg-gray-900 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center z-40 animate-slide-up"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center text-primary font-bold"
                id="mobile-cart-count"
              >
                0
              </div>
              <div class="flex flex-col text-left">
                <span class="text-xs text-gray-400" data-i18n="total"
                  >Total</span
                >
                <span class="font-bold text-lg" id="mobile-cart-total"
                  >$0.00</span
                >
              </div>
            </div>
            <div class="flex items-center gap-2 font-bold text-sm">
              <span data-i18n="view_order">View Order</span>
              <i class="fa-solid fa-chevron-right"></i>
            </div>
          </button>
        </div>

        <!-- TABLES VIEW -->
        <div
          id="view-tables"
          class="hidden flex-1 bg-white dark:bg-gray-800 rounded-[2rem] overflow-hidden flex flex-col h-full transition-colors duration-300"
        >
          <div class="p-4 md:p-8 h-full overflow-y-auto">
            <header
              class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4"
            >
              <div class="flex items-center gap-4">
                <button
                  onclick="toggleSidebar()"
                  class="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl lg:hidden"
                >
                  <i class="fa-solid fa-bars"></i>
                </button>
                <h1
                  class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
                  data-i18n="tables_title"
                >
                  Table Services
                </h1>
              </div>
              <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div
                  class="flex gap-3 sm:gap-4 overflow-x-auto hide-scrollbar pb-2 md:pb-0 w-full md:w-auto"
                >
                  <div class="flex items-center gap-2 whitespace-nowrap">
                    <div
                      class="w-3 h-3 rounded-full bg-gray-100 border border-gray-300"
                    ></div>
                    <span
                      class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium"
                      data-i18n="table_status_available"
                      >Available</span
                    >
                  </div>
                  <div class="flex items-center gap-2 whitespace-nowrap">
                    <div
                      class="w-3 h-3 rounded-full bg-green-100 border border-green-500"
                    ></div>
                    <span
                      class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium"
                      data-i18n="table_status_occupied"
                      >Occupied</span
                    >
                  </div>
                  <div class="flex items-center gap-2 whitespace-nowrap">
                    <div
                      class="w-3 h-3 rounded-full bg-blue-100 border border-blue-500"
                    ></div>
                    <span
                      class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium"
                      data-i18n="table_status_kitchen"
                      >Kitchen/Ready</span
                    >
                  </div>
                  <div class="flex items-center gap-2 whitespace-nowrap">
                    <div
                      class="w-3 h-3 rounded-full bg-purple-100 border border-purple-500"
                    ></div>
                    <span
                      class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium"
                      data-i18n="table_status_payment"
                      >Waiting Payment</span
                    >
                  </div>
                </div>
                <button
                  id="add-table-btn"
                  onclick="addNewTable()"
                  class="hidden bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:shadow-md transition-all whitespace-nowrap lg:ml-4"
                >
                  <i class="fa-solid fa-plus mr-2"></i
                  ><span data-i18n="add_table">Add Table</span>
                </button>
              </div>
            </header>

            <div
              id="tables-grid"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 pb-20"
            >
              <!-- Injected by JS -->
            </div>
          </div>
        </div>

        <!-- KITCHEN VIEW -->
        <div
          id="view-kitchen"
          class="hidden flex-1 bg-white dark:bg-gray-900 rounded-[2rem] overflow-hidden flex flex-col text-gray-800 dark:text-white transition-colors duration-300"
        >
          <header
            class="h-16 md:h-20 border-b border-gray-100 dark:border-gray-800 flex flex-wrap items-center justify-between px-4 md:px-8 bg-gray-50 dark:bg-gray-800/50 backdrop-blur-md"
          >
            <div class="flex items-center gap-4">
              <button
                onclick="toggleSidebar()"
                class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 lg:hidden"
              >
                <i class="fa-solid fa-bars"></i>
              </button>
              <h1 class="text-xl md:text-2xl font-bold flex items-center gap-3">
                <i class="fa-solid fa-fire-burner text-primary"></i>
                <span data-i18n="kitchen_title">Kitchen</span>
              </h1>
            </div>
            <div class="flex gap-3 sm:gap-4 text-xs md:text-sm">
              <div
                class="flex items-center gap-1 sm:gap-2 uppercase tracking-wide font-bold text-gray-500 dark:text-gray-300"
              >
                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                <span class="hidden sm:inline" data-i18n="kitchen_sent"
                  >Sent to Kitchen</span
                >
              </div>
              <div
                class="flex items-center gap-1 sm:gap-2 uppercase tracking-wide font-bold text-gray-500 dark:text-gray-300"
              >
                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                <span class="hidden sm:inline" data-i18n="kitchen_preparing"
                  >Preparing</span
                >
              </div>
            </div>
          </header>
          <div class="flex-1 p-4 md:p-6 overflow-y-auto custom-scrollbar">
            <div
              id="kitchen-grid"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 pb-20"
            >
              <!-- Tickets -->
            </div>
            <div
              id="kitchen-empty"
              class="hidden h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-600"
            >
              <i
                class="fa-solid fa-check-circle text-6xl mb-4 text-gray-300 dark:text-gray-700"
              ></i>
              <p
                class="text-xl font-medium text-center"
                data-i18n="kitchen_all_done"
              >
                All orders completed
              </p>
            </div>
          </div>
        </div>

        <!-- ADMIN VIEW -->
        <div
          id="view-admin"
          class="hidden flex-1 bg-gray-50 dark:bg-gray-900 rounded-[2rem] overflow-hidden flex flex-col transition-colors duration-300"
        >
          <div class="p-4 md:p-8 h-full overflow-y-auto hide-scrollbar">
            <!-- Header -->
            <header
              class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 md:mb-8"
            >
              <div class="flex items-center gap-4">
                <button
                  onclick="toggleSidebar()"
                  class="p-3 bg-white dark:bg-gray-800 rounded-xl shadow-sm lg:hidden hover:bg-gray-100 transition-colors"
                >
                  <i
                    class="fa-solid fa-bars text-gray-600 dark:text-gray-300"
                  ></i>
                </button>
                <div>
                  <div class="flex items-center gap-3 mb-1">
                    <span
                      class="w-2.5 h-2.5 rounded-full bg-primary shadow-lg shadow-primary/50 animate-pulse"
                    ></span>
                    <span
                      class="text-xs font-bold text-primary uppercase tracking-widest"
                      data-i18n="admin_live"
                      >Live Overview</span
                    >
                  </div>
                  <h1
                    class="text-2xl md:text-3xl font-black text-gray-900 dark:text-white"
                    data-i18n="admin_title"
                  >
                    Admin Dashboard
                  </h1>
                  <p
                    class="text-sm text-gray-400 mt-0.5"
                    data-i18n="admin_subtitle"
                  >
                    Today's performance at a glance
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div
                  class="hidden sm:flex items-center gap-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 px-4 py-2 rounded-xl shadow-sm text-sm text-gray-500 dark:text-gray-400 font-medium"
                >
                  <i class="fa-regular fa-calendar text-primary"></i>
                  <span id="admin-date-display"></span>
                </div>
                <button
                  onclick="renderAdmin()"
                  class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md shadow-primary/30 hover:shadow-lg hover:bg-primary-dark transition-all active:scale-95 flex items-center gap-2"
                >
                  <i class="fa-solid fa-rotate-right"></i>
                  <span data-i18n="admin_refresh">Refresh</span>
                </button>
              </div>
            </header>

            <!-- Metrics Grid -->
            <div
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-5 mb-6 md:mb-7"
            >
              <!-- Revenue Card -->
              <div
                class="p-5 md:p-6 rounded-3xl bg-gradient-to-br from-emerald-500 via-primary to-teal-600 text-white relative overflow-hidden shadow-xl shadow-primary/25 group hover:-translate-y-1.5 transition-all duration-300 cursor-default"
              >
                <div
                  class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-500"
                ></div>
                <div
                  class="absolute -left-4 -bottom-4 w-20 h-20 bg-white/5 rounded-full blur-xl"
                ></div>
                <div
                  class="flex justify-between items-start relative z-10 mb-5"
                >
                  <div
                    class="w-11 h-11 rounded-2xl bg-white/25 backdrop-blur-sm flex items-center justify-center text-lg shadow-inner"
                  >
                    <i class="fa-solid fa-dollar-sign"></i>
                  </div>
                  <span
                    class="bg-white/20 border border-white/30 px-2.5 py-1 rounded-xl text-[10px] font-extrabold uppercase tracking-wider backdrop-blur-sm flex items-center gap-1"
                  >
                    <i class="fa-solid fa-arrow-trend-up text-[8px]"></i> Today
                  </span>
                </div>
                <p
                  class="text-white/75 text-xs font-bold uppercase tracking-widest mb-1 relative z-10"
                  data-i18n="admin_revenue"
                >
                  Total Revenue
                </p>
                <h2
                  class="text-3xl md:text-4xl font-black tracking-tight relative z-10"
                  id="admin-revenue"
                >
                  $0.00
                </h2>
              </div>

              <!-- Orders Card -->
              <div
                class="p-5 md:p-6 rounded-3xl bg-gradient-to-br from-blue-400 via-blue-500 to-cyan-500 text-white relative overflow-hidden shadow-xl shadow-blue-500/25 group hover:-translate-y-1.5 transition-all duration-300 cursor-default"
              >
                <div
                  class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-500"
                ></div>
                <div
                  class="absolute -left-4 -bottom-4 w-20 h-20 bg-white/5 rounded-full blur-xl"
                ></div>
                <div
                  class="flex justify-between items-start relative z-10 mb-5"
                >
                  <div
                    class="w-11 h-11 rounded-2xl bg-white/25 backdrop-blur-sm flex items-center justify-center text-lg shadow-inner"
                  >
                    <i class="fa-solid fa-receipt"></i>
                  </div>
                  <span
                    class="bg-white/20 border border-white/30 px-2.5 py-1 rounded-xl text-[10px] font-extrabold uppercase tracking-wider backdrop-blur-sm"
                    data-i18n="today"
                    >Today</span
                  >
                </div>
                <p
                  class="text-white/75 text-xs font-bold uppercase tracking-widest mb-1 relative z-10"
                  data-i18n="admin_orders"
                >
                  Total Orders
                </p>
                <h2
                  class="text-3xl md:text-4xl font-black tracking-tight relative z-10"
                  id="admin-orders"
                >
                  0
                </h2>
              </div>

              <!-- Avg Order Card -->
              <div
                class="p-5 md:p-6 rounded-3xl bg-gradient-to-br from-violet-500 via-purple-500 to-fuchsia-500 text-white relative overflow-hidden shadow-xl shadow-purple-500/25 group hover:-translate-y-1.5 transition-all duration-300 cursor-default"
              >
                <div
                  class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-500"
                ></div>
                <div
                  class="absolute -left-4 -bottom-4 w-20 h-20 bg-white/5 rounded-full blur-xl"
                ></div>
                <div
                  class="flex justify-between items-start relative z-10 mb-5"
                >
                  <div
                    class="w-11 h-11 rounded-2xl bg-white/25 backdrop-blur-sm flex items-center justify-center text-lg shadow-inner"
                  >
                    <i class="fa-solid fa-chart-pie"></i>
                  </div>
                  <span
                    class="bg-white/20 border border-white/30 px-2.5 py-1 rounded-xl text-[10px] font-extrabold uppercase tracking-wider backdrop-blur-sm"
                    data-i18n="avg"
                    >Avg</span
                  >
                </div>
                <p
                  class="text-white/75 text-xs font-bold uppercase tracking-widest mb-1 relative z-10"
                  data-i18n="admin_avg"
                >
                  Avg Order Value
                </p>
                <h2
                  class="text-3xl md:text-4xl font-black tracking-tight relative z-10"
                  id="admin-avg-order"
                >
                  $0.00
                </h2>
              </div>

              <!-- Staff Card -->
              <div
                class="p-5 md:p-6 rounded-3xl bg-gradient-to-br from-orange-400 via-orange-500 to-rose-500 text-white relative overflow-hidden shadow-xl shadow-orange-500/25 group hover:-translate-y-1.5 transition-all duration-300 cursor-default"
              >
                <div
                  class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-500"
                ></div>
                <div
                  class="absolute -left-4 -bottom-4 w-20 h-20 bg-white/5 rounded-full blur-xl"
                ></div>
                <div
                  class="flex justify-between items-start relative z-10 mb-5"
                >
                  <div
                    class="w-11 h-11 rounded-2xl bg-white/25 backdrop-blur-sm flex items-center justify-center text-lg shadow-inner"
                  >
                    <i class="fa-solid fa-users"></i>
                  </div>
                  <span
                    class="bg-white/20 border border-white/30 px-2.5 py-1 rounded-xl text-[10px] font-extrabold uppercase tracking-wider backdrop-blur-sm"
                    >Live</span
                  >
                </div>
                <p
                  class="text-white/75 text-xs font-bold uppercase tracking-widest mb-1 relative z-10"
                  data-i18n="admin_staff"
                >
                  Active Staff
                </p>
                <h2
                  class="text-3xl md:text-4xl font-black tracking-tight relative z-10"
                  id="active-staff-count"
                >
                  0
                </h2>
              </div>
            </div>

            <!-- Charts Row -->
            <div
              class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-5 mb-6 md:mb-7"
            >
              <!-- Chart Card -->
              <div
                class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-3xl p-5 md:p-6 border border-gray-100 dark:border-gray-700 shadow-sm"
              >
                <div class="flex justify-between items-center mb-5">
                  <div>
                    <h3
                      class="font-bold text-base text-gray-800 dark:text-white flex items-center gap-2"
                    >
                      <span
                        class="w-7 h-7 rounded-lg bg-primary/10 text-primary flex items-center justify-center text-sm"
                      >
                        <i class="fa-solid fa-chart-column"></i>
                      </span>
                      Revenue Analytics
                    </h3>
                    <p class="text-xs text-gray-400 mt-1 ml-9">Last 7 days</p>
                  </div>
                  <div
                    class="bg-gray-50 dark:bg-gray-900/50 border border-gray-100 dark:border-gray-700 rounded-xl p-1 flex text-xs font-bold"
                  >
                    <button
                      class="px-3 py-1.5 bg-primary text-white shadow-sm rounded-lg"
                    >
                      7 Days
                    </button>
                  </div>
                </div>
                <div class="relative w-full h-[280px]">
                  <canvas id="salesChart"></canvas>
                </div>
              </div>

              <!-- Top Waiters Card -->
              <div
                class="bg-white dark:bg-gray-800 rounded-3xl p-5 md:p-6 border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col"
              >
                <div class="flex items-center gap-3 mb-5">
                  <div
                    class="w-9 h-9 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 text-white flex items-center justify-center shadow-lg shadow-orange-500/25"
                  >
                    <i class="fa-solid fa-trophy text-sm"></i>
                  </div>
                  <div>
                    <h3
                      class="font-bold text-base text-gray-800 dark:text-white leading-tight"
                    >
                      Top Waiters
                    </h3>
                    <p
                      class="text-[10px] text-gray-400 font-bold uppercase tracking-wider"
                    >
                      Today's Rankings
                    </p>
                  </div>
                </div>
                <ul id="top-waiters-list" class="space-y-2.5 flex-1">
                  <!-- Injected by JS -->
                  <li
                    class="flex items-center justify-center h-full text-gray-400 text-sm font-medium"
                  >
                    No orders yet today
                  </li>
                </ul>
              </div>
            </div>

            <!-- Payment Method Breakdown (Admin/Manager only) -->
            <div
              class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-sm p-5 md:p-6"
            >
              <div id="payment-summary-section">
                <!-- Injected by renderPaymentSummary() -->
              </div>
            </div>

            <div class="h-6"></div>

            <!-- Staff Table Row -->

            <div
              class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden"
            >
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-5 md:p-6 border-b border-gray-100 dark:border-gray-700/50"
              >
                <div>
                  <h3
                    class="font-bold text-base text-gray-800 dark:text-white flex items-center gap-2"
                  >
                    <span
                      class="w-7 h-7 rounded-lg bg-primary/10 text-primary flex items-center justify-center text-sm"
                    >
                      <i class="fa-solid fa-users-gear"></i>
                    </span>
                    <span data-i18n="admin_team">Team Management</span>
                  </h3>
                  <p
                    class="text-xs text-gray-400 mt-1 ml-9"
                    data-i18n="admin_team_sub"
                  >
                    Manage your staff roster
                  </p>
                </div>
                <button
                  id="add-staff-btn"
                  onclick="openAddStaffModal()"
                  class="w-full sm:w-auto bg-primary text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:shadow-lg hover:shadow-primary/25 transition-all flex items-center justify-center gap-2 active:scale-95"
                >
                  <i class="fa-solid fa-user-plus text-xs"></i>
                  <span data-i18n="admin_add_staff">Add Staff</span>
                </button>
              </div>
              <div class="overflow-x-auto hide-scrollbar">
                <table
                  class="w-full text-left text-sm text-gray-600 dark:text-gray-300 min-w-[500px]"
                >
                  <thead
                    class="text-[11px] uppercase tracking-wider font-bold text-gray-400 bg-gray-50 dark:bg-gray-900/40 border-b border-gray-100 dark:border-gray-700/50"
                  >
                    <tr>
                      <th class="px-6 py-4" data-i18n="staff_name">Name</th>
                      <th class="px-6 py-4" data-i18n="staff_role">Role</th>
                      <th class="px-6 py-4" data-i18n="staff_status">Status</th>
                      <th
                        class="px-6 py-4 text-right"
                        data-i18n="staff_actions"
                      >
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    class="divide-y divide-gray-50 dark:divide-gray-700/50"
                    id="staff-table-body"
                  >
                    <!-- Injected by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div
          id="view-settings"
          class="hidden flex-1 bg-gray-50 dark:bg-gray-900 rounded-[2rem] overflow-hidden flex flex-col h-full p-4 md:p-8 transition-colors duration-300"
        >
          <header class="flex items-center gap-4 mb-6 md:mb-8">
            <button
              onclick="toggleSidebar()"
              class="p-3 bg-white shadow-sm dark:bg-gray-800 rounded-xl lg:hidden"
            >
              <i class="fa-solid fa-bars"></i>
            </button>
            <h1
              class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
              data-i18n="settings_title"
            >
              Settings
            </h1>
          </header>

          <div class="max-w-xl">
            <h3
              class="font-bold text-lg text-gray-800 dark:text-white mb-5 pl-1"
              data-i18n="settings_appearance"
            >
              Appearance
            </h3>

            <div class="flex flex-col gap-5">
              <!-- Dark Mode Toggle -->
              <div
                class="flex items-center justify-between bg-white dark:bg-[#1E2530] rounded-3xl p-3 pl-4 pr-5 shadow-sm border border-gray-100 dark:border-gray-800/50 transition-colors"
              >
                <div class="flex items-center gap-5">
                  <div
                    class="w-14 h-14 bg-gray-50 dark:bg-[#343D4E] rounded-2xl flex items-center justify-center transition-colors"
                  >
                    <i
                      class="fa-solid fa-moon text-gray-600 dark:text-gray-300 text-2xl"
                    ></i>
                  </div>
                  <span
                    class="text-gray-800 dark:text-gray-200 font-medium text-xl"
                    data-i18n="settings_dark_mode"
                    >Dark Mode</span
                  >
                </div>
                <button
                  onclick="toggleDarkMode()"
                  id="dark-mode-toggle-settings"
                  class="w-[4.5rem] h-10 bg-gray-300 dark:bg-primary rounded-full relative transition-colors duration-300 flex-shrink-0 cursor-pointer"
                >
                  <div
                    class="w-8 h-8 bg-white rounded-full absolute top-1 left-1 dark:left-[1.85rem] transition-all duration-300 shadow-sm"
                  ></div>
                </button>
              </div>

              <!-- Language Toggle -->
              <div
                class="flex bg-white dark:bg-[#343D4E] rounded-3xl p-2.5 h-[4.5rem] shadow-sm border border-gray-100 dark:border-gray-800/50 transition-colors gap-2"
              >
                <button
                  id="lang-btn-settings-en"
                  onclick="setLanguage('en')"
                  class="flex-1 rounded-2xl text-white font-bold text-xl transition-all bg-primary shadow-sm tracking-wide"
                >
                  EN
                </button>
                <button
                  id="lang-btn-settings-so"
                  onclick="setLanguage('so')"
                  class="flex-1 rounded-2xl text-gray-500 dark:text-gray-300 font-bold text-xl hover:text-gray-800 dark:hover:text-white transition-all tracking-wide"
                >
                  SO
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- RESERVATION VIEW (Placeholder) -->
        <div
          id="view-reservation"
          class="hidden flex-1 bg-white dark:bg-gray-800 rounded-[2rem] overflow-hidden flex flex-col h-full p-4 md:p-8 transition-colors duration-300"
        >
          <header class="flex items-center gap-4 mb-6 md:mb-8">
            <button
              onclick="toggleSidebar()"
              class="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl lg:hidden"
            >
              <i class="fa-solid fa-bars"></i>
            </button>
            <h1
              class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
            >
              Reservation
            </h1>
          </header>
          <div
            class="flex-1 flex flex-col items-center justify-center text-gray-400 p-4 text-center"
          >
            <i
              class="fa-solid fa-calendar-check text-5xl md:text-6xl mb-4 text-gray-200 dark:text-gray-600"
            ></i>
            <p class="text-base md:text-lg font-medium">
              Reservation Module Coming Soon
            </p>
          </div>
        </div>

        <!-- RECEIPT VIEW (Placeholder) -->
        <div
          id="view-receipt"
          class="hidden flex-1 bg-white dark:bg-gray-800 rounded-[2rem] overflow-hidden flex flex-col h-full p-4 md:p-8 transition-colors duration-300"
        >
          <header class="flex items-center gap-4 mb-6 md:mb-8">
            <button
              onclick="toggleSidebar()"
              class="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl lg:hidden"
            >
              <i class="fa-solid fa-bars"></i>
            </button>
            <h1
              class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
            >
              Receipt
            </h1>
          </header>
          <div
            class="flex-1 flex flex-col items-center justify-center text-gray-400 p-4 text-center"
          >
            <i
              class="fa-solid fa-receipt text-5xl md:text-6xl mb-4 text-gray-200 dark:text-gray-600"
            ></i>
            <p class="text-base md:text-lg font-medium">
              Receipt Module Coming Soon
            </p>
          </div>
        </div>

        <!-- ORDERS VIEW -->
        <div
          id="view-orders"
          class="hidden flex-1 bg-gray-50 dark:bg-gray-900 rounded-[2rem] overflow-y-auto flex flex-col p-4 md:p-8 transition-colors duration-300"
        >
          <header class="flex items-center justify-between gap-4 mb-6 md:mb-8">
            <div class="flex items-center gap-4">
              <button
                onclick="toggleSidebar()"
                class="p-3 bg-white shadow-sm dark:bg-gray-800 rounded-xl lg:hidden"
              >
                <i class="fa-solid fa-bars"></i>
              </button>
              <div>
                <h1
                  class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-1"
                  data-i18n="orders_title"
                >
                  Orders Registry
                </h1>
                <p
                  class="text-sm text-gray-500 dark:text-gray-400"
                  data-i18n="orders_subtitle"
                >
                  Track and manage all completed transactions.
                </p>
              </div>
            </div>
            <div
              class="hidden sm:flex items-center gap-3 bg-white dark:bg-gray-800 px-4 py-2 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"
            >
              <div
                class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
              ></div>
              <span
                class="text-sm font-semibold text-gray-600 dark:text-gray-300"
                data-i18n="orders_live_sync"
                >Live Sync</span
              >
            </div>
          </header>

          <div class="flex-1 flex flex-col">
            <div
              class="overflow-x-auto hide-scrollbar flex-1 -mx-4 px-4 md:mx-0 md:px-0"
            >
              <table
                class="w-full text-left min-w-[800px] border-separate border-spacing-y-3"
              >
                <thead class="sticky top-0 z-10 bg-gray-50 dark:bg-gray-900">
                  <tr
                    class="text-xs uppercase tracking-wider font-bold text-gray-400 dark:text-gray-500 pb-2"
                  >
                    <th
                      class="px-6 py-3 font-medium"
                      data-i18n="orders_col_details"
                    >
                      Order Details
                    </th>
                    <th
                      class="px-6 py-3 font-medium"
                      data-i18n="orders_col_assigned"
                    >
                      Assigned To
                    </th>
                    <th
                      class="px-6 py-3 font-medium"
                      data-i18n="orders_col_summary"
                    >
                      Order Summary
                    </th>
                    <th
                      class="px-6 py-3 font-medium text-right"
                      data-i18n="orders_col_amount"
                    >
                      Amount Paid
                    </th>
                    <th
                      class="px-6 py-3 font-medium text-right"
                      data-i18n="orders_col_time"
                    >
                      Timestamp
                    </th>
                    <th
                      class="px-6 py-3 font-medium text-right"
                      data-i18n="orders_col_print"
                    >
                      Print
                    </th>
                  </tr>
                </thead>
                <tbody id="orders-table-body">
                  <!-- Injected by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RECEIPT MODAL -->
    <div
      id="receipt-modal"
      class="hidden fixed inset-0 bg-black/60 z-[70] flex flex-col items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-white rounded-lg shadow-2xl relative flex flex-col max-h-[90vh] w-full max-w-sm overflow-hidden animate-slide-up"
      >
        <!-- Receipt Content -->
        <div
          id="printable-receipt"
          class="p-6 overflow-y-auto bg-white text-black font-mono text-sm"
        >
          <div class="text-center mb-6">
            <div class="text-black text-3xl mx-auto mb-3">
              <i class="fa-solid fa-leaf"></i>
            </div>
            <h2
              class="text-2xl font-black uppercase tracking-widest mb-1 text-gray-900"
            >
              Hudheel Bile
            </h2>
            <p class="text-gray-500 text-xs font-semibold">Tuwali</p>
            <p class="text-gray-500 text-xs">Tel: +252 63 4308432</p>
            <div
              class="mt-4 border-b border-dashed border-gray-400 pb-4 flex justify-between text-xs"
            >
              <span id="receipt-date"></span>
              <span id="receipt-time"></span>
            </div>
          </div>

          <div class="mb-4">
            <div class="flex justify-between text-xs mb-1">
              <span
                >Order: <span id="receipt-order-id" class="font-bold"></span
              ></span>
              <span
                >Table: <span id="receipt-table" class="font-bold"></span
              ></span>
            </div>
            <div class="text-xs">Waiter: <span id="receipt-waiter"></span></div>
          </div>

          <table class="w-full text-left mb-4">
            <thead>
              <tr class="border-y border-dashed border-gray-400">
                <th class="py-2 text-xs font-normal">Item</th>
                <th class="py-2 text-xs font-normal text-center">Qty</th>
                <th class="py-2 text-xs font-normal text-right">Price</th>
              </tr>
            </thead>
            <tbody id="receipt-items">
              <!-- Injected -->
            </tbody>
          </table>

          <div class="flex justify-between text-xs mb-1">
            <span>Subtotal</span>
            <span id="receipt-subtotal"></span>
          </div>
          <div
            class="flex justify-between text-xs mb-3 border-b border-dashed border-gray-400 pb-3"
          >
            <span>Tax (5%)</span>
            <span id="receipt-tax"></span>
          </div>
          <div class="flex justify-between text-lg font-bold">
            <span>TOTAL</span>
            <span id="receipt-total"></span>
          </div>

          <div class="text-center mt-8 text-xs text-gray-500 italic">
            Thank you for dining with us!
          </div>
        </div>

        <!-- Payment Actions (Not Printed) -->
        <div class="bg-gray-100 p-4 border-t border-gray-200">
          <div class="flex gap-2">
            <button
              onclick="closeReceiptModal()"
              class="flex-1 py-3 text-gray-600 font-bold bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors"
            >
              Cancel
            </button>
            <button
              onclick="processReceiptPayment()"
              class="flex-1 py-3 text-white font-bold bg-green-600 hover:bg-green-700 rounded-xl shadow-lg transition-colors"
            >
              Pay & Print
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Tables Modal -->
    <div
      id="add-table-modal"
      class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4"
    >
      <div
        id="add-table-content"
        class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 border border-gray-100 dark:border-gray-700"
      >
        <!-- Accent Header -->
        <div
          class="bg-gradient-to-br from-primary to-emerald-700 px-7 pt-7 pb-10 relative overflow-hidden"
        >
          <div
            class="absolute -top-6 -right-6 w-28 h-28 bg-white/10 rounded-full"
          ></div>
          <div
            class="absolute -bottom-4 -left-4 w-20 h-20 bg-white/10 rounded-full"
          ></div>
          <div class="flex justify-between items-start relative z-10">
            <div>
              <div
                class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3"
              >
                <i class="fa-solid fa-table-cells text-white text-lg"></i>
              </div>
              <h2
                class="text-2xl font-extrabold text-white"
                data-i18n="add_table"
              >
                Add Tables
              </h2>
              <p
                class="text-white/70 text-sm mt-1"
                data-i18n="prompt_add_tables"
              >
                How many tables would you like to add?
              </p>
            </div>
            <button
              onclick="closeAddTableModal()"
              class="w-9 h-9 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-colors"
            >
              <i class="fa-solid fa-xmark text-lg"></i>
            </button>
          </div>
        </div>

        <!-- Form Body -->
        <div
          class="-mt-6 bg-white dark:bg-gray-900 rounded-t-[2rem] px-7 pt-7 pb-7 space-y-5"
        >
          <div>
            <label
              class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
              >Number of Tables</label
            >
            <input
              type="number"
              id="add-table-count"
              value="1"
              min="1"
              max="50"
              class="w-full px-4 py-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white text-2xl font-bold text-center focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all tracking-widest"
            />
          </div>

          <div class="flex gap-3 pt-1">
            <button
              onclick="closeAddTableModal()"
              class="flex-1 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-sm"
              data-i18n="cancel"
            >
              Cancel
            </button>
            <button
              onclick="confirmAddTable()"
              class="flex-1 py-3.5 rounded-xl bg-primary hover:bg-emerald-600 text-white font-bold shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all active:scale-95 text-sm flex items-center justify-center gap-2"
            >
              <i class="fa-solid fa-plus"></i>
              <span data-i18n="add_table">Add Tables</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div
      id="add-staff-modal"
      class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300 p-4"
    >
      <div
        class="bg-white dark:bg-gray-900 w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 border border-gray-100 dark:border-gray-700"
        id="add-staff-content"
      >
        <!-- Accent Header -->
        <div
          class="bg-gradient-to-br from-primary to-emerald-700 px-7 pt-7 pb-10 relative overflow-hidden"
        >
          <div
            class="absolute -top-6 -right-6 w-28 h-28 bg-white/10 rounded-full"
          ></div>
          <div
            class="absolute -bottom-4 -left-4 w-20 h-20 bg-white/10 rounded-full"
          ></div>
          <div class="flex justify-between items-start relative z-10">
            <div>
              <div
                class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3"
              >
                <i class="fa-solid fa-user-plus text-white text-lg"></i>
              </div>
              <h2
                class="text-2xl font-extrabold text-white"
                id="modal-title"
                data-i18n="modal_add_staff"
              >
                Add New Staff
              </h2>
              <p
                class="text-white/70 text-sm mt-1"
                data-i18n="modal_fill_details"
              >
                Fill in the details below
              </p>
            </div>
            <button
              onclick="closeAddStaffModal()"
              class="w-9 h-9 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-colors"
            >
              <i class="fa-solid fa-xmark text-lg"></i>
            </button>
          </div>
        </div>

        <!-- Form Body (pulled up over header) -->
        <div
          class="-mt-6 bg-white dark:bg-gray-900 rounded-t-[2rem] px-7 pt-7 pb-7 space-y-5"
        >
          <!-- Full Name -->
          <div>
            <label
              class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
              data-i18n="modal_full_name"
              >Full Name</label
            >
            <input
              type="text"
              id="new-staff-name"
              class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
              placeholder="e.g. Jane Doe"
            />
          </div>

          <!-- Role -->
          <div id="new-staff-role-container">
            <label
              class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
              data-i18n="modal_role"
              >Role</label
            >
            <div class="relative">
              <select
                id="new-staff-role"
                class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all appearance-none cursor-pointer"
              >
                <option value="Waiter">Waiter</option>
                <option value="Manager">Manager</option>
                <option value="Chef">Chef</option>
                <option value="Cashier">Cashier</option>
              </select>
              <i
                class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-sm"
              ></i>
            </div>
          </div>

          <!-- Access PIN -->
          <div>
            <label
              class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
              data-i18n="modal_pin"
              >Access PIN</label
            >
            <input
              type="text"
              id="new-staff-pin"
              value="1234"
              class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white font-mono tracking-[0.5em] text-center focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-lg"
            />
          </div>

          <!-- Buttons -->
          <div class="flex gap-3 pt-2">
            <button
              onclick="closeAddStaffModal()"
              class="flex-1 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-sm"
              data-i18n="modal_cancel"
            >
              Cancel
            </button>
            <button
              onclick="saveStaff()"
              id="modal-submit-btn"
              class="flex-1 py-3.5 rounded-xl bg-primary hover:bg-emerald-600 text-white font-bold shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all active:scale-95 text-sm"
              data-i18n="modal_add_btn"
            >
              Add Staff Member
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div
      id="add-product-modal"
      class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300 p-4"
    >
      <div
        class="bg-white dark:bg-gray-900 w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 border border-gray-100 dark:border-gray-700"
        id="add-product-content"
      >
        <!-- Accent Header -->
        <div
          class="bg-gradient-to-br from-primary to-emerald-700 px-7 pt-7 pb-10 relative overflow-hidden"
        >
          <div
            class="absolute -top-6 -right-6 w-28 h-28 bg-white/10 rounded-full"
          ></div>
          <div
            class="absolute -bottom-4 -left-4 w-20 h-20 bg-white/10 rounded-full"
          ></div>
          <div class="flex justify-between items-start relative z-10">
            <div>
              <div
                class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3"
              >
                <i class="fa-solid fa-utensils text-white text-lg"></i>
              </div>
              <h2
                class="text-2xl font-extrabold text-white"
                id="product-modal-title"
              >
                Add New Item
              </h2>
              <p class="text-white/70 text-sm mt-1">
                Fill in the item details below
              </p>
            </div>
            <button
              onclick="closeAddProductModal()"
              class="w-9 h-9 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-colors"
            >
              <i class="fa-solid fa-xmark text-lg"></i>
            </button>
          </div>
        </div>

        <!-- Form Body -->
        <div
          class="-mt-6 bg-white dark:bg-gray-900 rounded-t-[2rem] px-7 pt-7 pb-7 space-y-5"
        >
          <!-- Item Name -->
          <div>
            <label
              class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
              >Item Name</label
            >
            <input
              type="text"
              id="product-name"
              class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
              placeholder="e.g. Beef Burger"
            />
          </div>

          <!-- Price + Category -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
                >Price ($)</label
              >
              <input
                type="number"
                id="product-price"
                step="0.01"
                class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                placeholder="0.00"
              />
            </div>
            <div>
              <label
                class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
                >Category</label
              >
              <select
                id="product-category"
                class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all appearance-none cursor-pointer"
              >
                <!-- Populated by JS -->
              </select>
            </div>
          </div>

          <!-- Item Image Upload -->
          <div>
            <label
              class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
              >Item Image</label
            >
            <div class="relative group cursor-pointer">
              <input
                type="file"
                id="product-image-file"
                accept="image/*"
                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                onchange="previewProductImage(this)"
              />
              <div
                id="product-image-preview-container"
                class="w-full h-32 rounded-xl border-2 border-dashed border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 group-hover:border-primary group-hover:bg-primary/5 dark:group-hover:bg-primary/10 transition-all overflow-hidden relative"
              >
                <div
                  id="product-image-placeholder"
                  class="flex flex-col items-center gap-2"
                >
                  <div
                    class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-xl flex items-center justify-center group-hover:bg-primary/10 transition-colors"
                  >
                    <i
                      class="fa-solid fa-cloud-arrow-up text-xl text-gray-400 dark:text-gray-500 group-hover:text-primary transition-colors"
                    ></i>
                  </div>
                  <span
                    class="text-xs font-medium text-gray-500 dark:text-gray-400"
                    >Click or drag to upload image</span
                  >
                </div>
                <img
                  id="product-image-preview"
                  src=""
                  class="absolute inset-0 w-full h-full object-cover hidden pointer-events-none"
                />
              </div>
            </div>
            <input type="hidden" id="product-image-data" />
          </div>

          <!-- Buttons -->
          <div class="flex gap-3 pt-1">
            <button
              onclick="closeAddProductModal()"
              class="flex-1 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-sm"
            >
              Cancel
            </button>
            <button
              onclick="saveProduct()"
              id="product-modal-btn"
              class="flex-1 py-3.5 rounded-xl bg-primary hover:bg-emerald-600 text-white font-bold shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all active:scale-95 text-sm flex items-center justify-center gap-2"
            >
              <i class="fa-solid fa-floppy-disk"></i>
              <span>Save Item</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div
      id="add-category-modal"
      class="fixed inset-0 bg-gray-950/80 backdrop-blur-md z-[80] hidden flex items-center justify-center p-4 transition-all duration-500"
    >
      <div
        id="add-category-content"
        class="bg-white dark:bg-gray-900 w-full max-w-md max-h-[90vh] rounded-[2.5rem] shadow-[0_32px_64px_-16px_rgba(0,0,0,0.3)] overflow-hidden transform scale-95 opacity-0 transition-all duration-500 border border-white/10 flex flex-col"
      >
        <!-- Compact Gradient Header -->
        <div
          class="h-24 bg-gradient-to-br from-emerald-400 via-primary to-teal-500 relative flex-shrink-0"
        >
          <div
            class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10 mix-blend-overlay"
          ></div>
          <button
            onclick="closeCategoryModal()"
            class="absolute top-4 right-4 w-9 h-9 rounded-full bg-white/20 backdrop-blur-md text-white hover:bg-white/30 transition-all flex items-center justify-center border border-white/20"
          >
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <!-- Floating Icon - Smaller on mobile -->
        <div class="relative -mt-10 flex justify-center px-6 flex-shrink-0">
          <div
            class="w-20 h-20 rounded-2xl bg-white dark:bg-gray-800 shadow-xl flex items-center justify-center text-3xl text-primary border-4 border-white dark:border-gray-900 animate-bounce-slow"
          >
            <i id="category-icon-preview" class="fa-solid fa-tag"></i>
          </div>
        </div>

        <!-- Scrollable Body -->
        <div
          class="px-6 md:px-10 pb-8 pt-4 text-center overflow-y-auto custom-scrollbar"
        >
          <h2
            id="category-modal-title"
            class="text-2xl font-black text-gray-800 dark:text-white tracking-tight mb-1"
          >
            Add New Category
          </h2>
          <p class="text-sm text-gray-400 dark:text-gray-500 font-medium mb-6">
            Create a new section for your menu
          </p>

          <!-- Form Rows -->
          <div class="space-y-5 text-left mb-8">
            <div class="group">
              <label
                class="block text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-2 px-1 group-focus-within:text-primary transition-colors"
                >Category Name</label
              >
              <input
                type="text"
                id="category-name"
                placeholder="Name (e.g. Pizza, Pasta)"
                class="w-full h-14 px-5 rounded-2xl bg-gray-50 dark:bg-gray-800/50 border-2 border-transparent focus:border-primary/20 focus:bg-white dark:focus:bg-gray-800 outline-none transition-all font-bold text-gray-800 dark:text-white placeholder-gray-300 dark:placeholder-gray-600 shadow-inner text-sm"
              />
            </div>

            <div class="group">
              <label
                class="block text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 mb-2 px-1 group-focus-within:text-primary transition-colors"
                >Select Icon</label
              >
              <div
                id="icon-picker-grid"
                class="grid grid-cols-6 gap-2 mb-3 max-h-32 overflow-y-auto p-2 bg-gray-50 dark:bg-gray-800/50 rounded-2xl border-2 border-transparent focus-within:border-primary/20 transition-all custom-scrollbar"
              >
                <!-- Icons injected via JS -->
              </div>
              <div class="relative">
                <i
                  class="fa-solid fa-magic absolute left-5 top-1/2 -translate-y-1/2 text-primary/40 text-lg"
                ></i>
                <input
                  type="text"
                  id="category-icon"
                  placeholder="Or type fa-icon name..."
                  oninput="
                    document.getElementById('category-icon-preview').className =
                      'fa-solid ' + (this.value || 'fa-tag')
                  "
                  class="w-full h-14 pl-12 pr-5 rounded-2xl bg-gray-50 dark:bg-gray-800/50 border-2 border-transparent focus:border-primary/20 focus:bg-white dark:focus:bg-gray-800 outline-none transition-all font-bold text-gray-800 dark:text-white placeholder-gray-300 dark:placeholder-gray-600 shadow-inner text-sm"
                />
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div
            class="flex gap-3 sticky bottom-0 bg-white dark:bg-gray-900 pt-2"
          >
            <button
              onclick="closeCategoryModal()"
              class="flex-1 py-3.5 px-4 rounded-xl border-2 border-gray-100 dark:border-gray-800 text-gray-500 dark:text-gray-400 font-bold hover:bg-gray-50 dark:hover:bg-gray-800 transition-all active:scale-95 text-sm"
            >
              Cancel
            </button>
            <button
              onclick="saveCategory()"
              id="category-modal-btn"
              class="flex-[1.5] py-3.5 px-4 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-black shadow-[0_12px_24px_-8px_rgba(16,185,129,0.5)] hover:shadow-[0_20px_32px_-12px_rgba(16,185,129,0.6)] hover:-translate-y-1 transition-all active:scale-95 flex items-center justify-center gap-2 text-sm"
            >
              <i class="fa-solid fa-sparkles"></i>
              <span>Save Category</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Global Alerts/Notifications -->
    <div
      id="toast"
      class="fixed top-6 right-6 left-6 md:left-auto bg-gray-900 text-white px-5 py-3.5 rounded-2xl shadow-2xl transform translate-y-[-100px] md:translate-y-0 md:translate-x-40 opacity-0 transition-all duration-300 z-[70] flex items-center gap-3 pointer-events-none cursor-pointer min-w-[260px]"
      onclick="dismissToast()"
    >
      <i
        class="fa-solid fa-circle-info text-primary text-xl flex-shrink-0"
        id="toast-icon"
      ></i>
      <div class="flex flex-col flex-1 min-w-0">
        <span class="font-bold text-sm" id="toast-title">Success</span>
        <span id="toast-msg" class="text-xs text-gray-300 truncate"
          >Operation successful</span
        >
      </div>
      <button
        onclick="
          event.stopPropagation();
          dismissToast();
        "
        class="w-6 h-6 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center flex-shrink-0 transition-colors ml-1"
      >
        <i class="fa-solid fa-xmark text-xs text-gray-300"></i>
      </button>
    </div>

    <script>
      // --- MOBILE UI LOGIC ---
      function toggleSidebar() {
        const sidebar = document.getElementById("main-sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        const mobileCartBtn = document.getElementById("mobile-cart-btn");

        if (sidebar.classList.contains("sidebar-mobile-hidden")) {
          sidebar.classList.remove("sidebar-mobile-hidden");
          sidebar.classList.add("sidebar-mobile-visible");
          overlay.classList.remove("hidden");
          if (mobileCartBtn) mobileCartBtn.classList.add("hidden");
        } else {
          sidebar.classList.add("sidebar-mobile-hidden");
          sidebar.classList.remove("sidebar-mobile-visible");
          overlay.classList.add("hidden");
          if (mobileCartBtn) mobileCartBtn.classList.remove("hidden");
        }
      }

      function toggleMobileCart() {
        const cart = document.getElementById("pos-cart-panel");
        const btn = document.getElementById("mobile-cart-btn");

        if (cart.classList.contains("cart-mobile-hidden")) {
          cart.classList.remove("cart-mobile-hidden");
          cart.classList.add("cart-mobile-visible");
          btn.classList.add("hidden"); // Hide button when cart open
        } else {
          cart.classList.add("cart-mobile-hidden");
          cart.classList.remove("cart-mobile-visible");
          btn.classList.remove("hidden"); // Show button
        }
      }

      function updateMobileCartButton() {
        const activeTable = tables.find((t) => t.id === activeTableId);
        const count = activeTable
          ? activeTable.cart.reduce((sum, i) => sum + i.qty, 0)
          : 0;
        const total = activeTable
          ? activeTable.cart.reduce((sum, i) => sum + i.price * i.qty, 0)
          : 0;

        document.getElementById("mobile-cart-count").innerText = count;
        document.getElementById("mobile-cart-total").innerText =
          `$${total.toFixed(2)}`;

        const btn = document.getElementById("mobile-cart-btn");
        const cartPanel = document.getElementById("pos-cart-panel");

        // Only show if not empty and cart not open
        if (count > 0 && cartPanel.classList.contains("cart-mobile-hidden")) {
          btn.classList.remove("hidden");
        } else if (count === 0) {
          btn.classList.add("hidden");
        }
      }

      // --- TIME FORMATTER ---
      function formatTime(date) {
        let h = date.getHours();
        const m = date.getMinutes().toString().padStart(2, "0");
        const ampm = h >= 12 ? "pm" : "am";
        h = h % 12 || 12;
        return `${h}:${m}${ampm}`;
      }

      // --- GLOBAL STATE ---
      let currentUser = null;
      let selectedRole = null;

      // --- WALKIE TALKIE RECEIVER ---
      // --- WALKIE TALKIE RECEIVER (ALL CHANNELS) ---
      const socket = io();

      // 1. Listen for Table & Kitchen Updates
      socket.on("sync_state", (data) => {
        data.tables.forEach((serverTable) => {
          const localIndex = tables.findIndex((t) => t.id === serverTable.id);
          if (localIndex !== -1) {
            tables[localIndex] = { ...tables[localIndex], ...serverTable };
          } else {
            // Adds the brand new tables sent from the server!
            tables.push(serverTable);
          }
        });
        kitchenOrders = data.kitchenOrders;

        if (
          !document.getElementById("view-tables").classList.contains("hidden")
        )
          renderTablesView();
        if (
          !document.getElementById("view-kitchen").classList.contains("hidden")
        )
          renderKitchen();
        if (!document.getElementById("view-pos").classList.contains("hidden")) {
          renderMenu();
          renderCart();
        }
      });

      // 2. Listen for Pop-up Notifications
      socket.on("toast", (data) => {
        if (!currentUser) return;
        if (
          !data.roleTarget ||
          data.roleTarget === currentUser.role ||
          currentUser.role === "Admin"
        ) {
          showToast(data.msg, data.type);
        }
      });

      // 3. Listen for Money/Receipts (Admin & Cashier)
      socket.on("sync_history", (newHistory) => {
        if (newHistory && newHistory.length > 0) {
          orderHistory = newHistory;
          localStorage.setItem("pos_history", JSON.stringify(orderHistory));

          // Instantly update the screen if Admin or Cashier is looking at it!
          if (
            !document.getElementById("view-admin").classList.contains("hidden")
          )
            renderAdmin();
          if (
            !document.getElementById("view-orders").classList.contains("hidden")
          )
            renderOrderHistory();
        }
      });

      socket.on("order_completed", () => {
        if (!document.getElementById("view-admin").classList.contains("hidden"))
          renderAdmin();
      });
      // --- STAFF DATA ---
      let staffList = JSON.parse(localStorage.getItem("pos_staff")) || [
        {
          id: 1,
          name: "Admin User",
          role: "Admin",
          status: "Active",
          pin: "1234",
          avatar: "Admin",
        },
        {
          id: 2,
          name: "Floyd Miles",
          role: "Manager",
          status: "Active",
          pin: "1234",
          avatar: "Floyd+Miles",
        },
        {
          id: 3,
          name: "Arlene McCoy",
          role: "Waiter",
          status: "Active",
          pin: "1234",
          avatar: "Arlene+McCoy",
        },
        {
          id: 4,
          name: "Esther Howard",
          role: "Waiter",
          status: "Active",
          pin: "1234",
          avatar: "Esther+Howard",
        },
        {
          id: 5,
          name: "Chef Gordon",
          role: "Chef",
          status: "Offline",
          pin: "1234",
          avatar: "Chef",
        },
        {
          id: 6,
          name: "Cash Register",
          role: "Cashier",
          status: "Active",
          pin: "1234",
          avatar: "Register",
        },
      ];

      // ==========================================
      // --- I18N: LANGUAGE SYSTEM ---
      // ==========================================
      let currentLang = localStorage.getItem("hudheel_lang") || "en";

      const TRANSLATIONS = {
        en: {
          // Sidebar
          nav_dashboard: "Dashboard",
          nav_tables: "Tables",
          nav_menu: "Menu",
          nav_kitchen: "Kitchen",
          nav_orders: "Orders",
          nav_payments: "Payments",
          nav_settings: "Settings",
          nav_logout: "Logout",
          dark_mode: "Dark Mode",
          // POS Cart
          current_order: "Current Order",
          dine_in: "Customer Order",
          sub_total: "Sub Total",
          tax: "Tax 5%",
          total_amount: "Total Amount",
          pay_cash: "Cash",
          pay_card: "Zaad",
          pay_qr: "E-dahab",
          send_to_kitchen: "Send to Kitchen",
          recall_order: "Recall Order",
          waiting_chef: "Waiting for Chef...",
          pay_print: "Pay & Print",
          view_order: "View Order",
          total: "Total",
          search_placeholder: "Search Product...",
          // Tables View
          tables_title: "Table Services",
          tables_subtitle: "Select a table to begin or manage orders.",
          table_status_available: "Available",
          table_status_occupied: "Occupied",
          table_status_kitchen: "Kitchen/Ready",
          table_status_payment: "Waiting Payment",
          table_btn_select: "Select Table",
          table_btn_open: "Open",
          table_empty_cart: "No items in cart",
          add_table: "Add Table",
          table_added: "New table added successfully!",
          prompt_add_tables: "How many tables would you like to add?",
          toast_invalid_number: "Please enter a valid number.",
          // Kitchen View
          kitchen_title: "Kitchen",
          kitchen_sent: "Sent to Kitchen",
          kitchen_preparing: "Preparing",
          kitchen_new_badge: "New Order",
          kitchen_start: "Start Preparing",
          kitchen_mark_ready: "Mark Ready",
          ready_to_serve: "Ready to Serve",

          kitchen_all_done: "All orders completed",
          // Admin Dashboard
          admin_title: "Admin Dashboard",
          admin_subtitle: "Today's performance at a glance",
          admin_live: "Live Overview",
          admin_refresh: "Refresh",
          admin_revenue: "Total Revenue",
          admin_orders: "Total Orders",
          admin_avg: "Avg Order Value",
          admin_staff: "Active Staff",
          admin_chart_title: "Revenue Analytics",
          admin_chart_sub: "Last 7 days",
          admin_days7: "7 Days",
          admin_top_waiters: "Top Waiters",
          admin_top_rank: "Today's Rankings",
          admin_team: "Team Management",
          admin_team_sub: "Manage your staff roster",
          admin_add_staff: "Add Staff",
          admin_no_waiters: "No orders yet today.",
          admin_no_staff: "No staff found.",
          // Orders View
          orders_title: "Orders Registry",
          orders_subtitle: "Track and manage all completed transactions.",
          orders_col_details: "Order Details",
          orders_col_assigned: "Assigned To",
          orders_col_summary: "Order Summary",
          orders_col_amount: "Amount Paid",
          orders_col_time: "Timestamp",
          orders_col_print: "Print",
          orders_paid: "Paid",
          orders_empty: "No completed orders yet today.",
          orders_items: "Items",
          orders_live_sync: "Live Sync",
          // Receipt Modal
          receipt_cancel: "Cancel",
          receipt_pay_print: "Pay & Print",
          receipt_close: "Close",
          receipt_print: "Print Receipt",
          // Settings
          settings_title: "Settings",
          settings_appearance: "Appearance",
          settings_dark_mode: "Dark Mode",
          settings_dark_sub: "Switch between light and dark themes",
          settings_lang: "Language",
          settings_lang_sub: "Choose your preferred language",
          // Staff Table
          staff_name: "Name",
          staff_role: "Role",
          staff_status: "Status",
          staff_actions: "Actions",
          // Add Staff Modal
          modal_add_staff: "Add New Staff",
          modal_edit_staff: "Edit Staff",
          modal_fill_details: "Fill in the details below",

          modal_full_name: "Full Name",
          modal_role: "Role",
          modal_pin: "PIN",
          modal_status: "Status",
          modal_cancel: "Cancel",
          modal_save: "Save Changes",
          modal_add_btn: "Add Staff Member",
          // Notifications
          notif_order_ready: "Order Ready",
          notif_mark_read: "Mark all as read",
          // General
          close: "Close",
          cancel: "Cancel",
          save: "Save",
          edit: "Edit",
          active: "Active",
          inactive: "Inactive",
          // Roles
          role_admin: "Admin",
          role_manager: "Manager",
          role_waiter: "Waiter",
          role_chef: "Chef",
          role_cashier: "Cashier",
          today: "Today",
          avg: "Avg",
          orders_badge: "Orders",
          live_badge: "Live",
          // Toast Messages
          toast_title_success: "Success",
          toast_title_error: "Action Denied",
          toast_title_info: "Notification",
          toast_title_warning: "Warning",
          toast_select_table: "Please select a table first",
          toast_recalled: "Order recalled to Draft status.",
          toast_kitchen_waiting: "Order is waiting in the kitchen queue.",
          toast_sent_kitchen: "Order sent to kitchen!",
          toast_paid: "Payment successful!",
          toast_table_occupied: "Table is already occupied.",
          toast_staff_added: "Staff member added.",
          toast_staff_updated: "Staff member updated.",
          toast_staff_deleted: "Staff member deleted.",
          toast_order_ready: "Order is Ready to Serve!",
          toast_add_items: "Please add items to the cart first.",
          toast_fill_fields: "Please fill in all required fields.",
          toast_no_recent_orders:
            "No recent orders found for this table to reopen.",
          toast_order_too_old:
            "Last order is too old to safely reopen (> 2 hours).",
          toast_table_restored: "Table {id} restored to WAITING PAYMENT.",
          confirm_reopen:
            "Admin Action: Do you want to reopen the last closed order for {id}? Total was ${total}.",
          toast_admin_only: "Only Admin or Manager can manage menu items.",
          toast_enter_name: "Please enter an item name.",
          toast_enter_price: "Please enter a valid price.",
          toast_select_category: "Please select a category.",
          toast_item_updated: "Item updated successfully!",
          toast_item_added: "Item added successfully!",
          toast_item_deleted: "Item Deleted",
          toast_cannot_modify_sent:
            "Cannot modify an order that has been sent to the kitchen.",
          toast_cannot_release_kitchen:
            "Cannot release a table after the order has been sent to the kitchen.",
          toast_no_permission_release:
            "You do not have permission to release this table.",
          toast_table_released: "Table released successfully.",
          toast_order_served: "Order marked as served.",
          toast_order_fully_paid:
            "Order already fully paid. Releasing table...",
          toast_in_kitchen: "Order is currently in the kitchen.",
          toast_remote_release: "Table was released remotely. Redirecting...",
          confirm_remove_staff: "Remove this staff member?",
          confirm_delete_item: "Delete this item permanently?",
          alert_admin_only_delete: "Only Admins can delete staff.",
          // Release Modal
          release_title: "Release Table",
          release_confirm_msg: "Are you sure you want to release this table?",
          release_confirm_sub: "Unsaved items will be lost.",
          release_keep: "Keep Table",
          release_yes: "Yes, Release",
          // Table Status Labels (used on table cards)
          status_available: "Available",
          status_occupied: "Occupied",
          status_sending: "Sending...",
          status_sent: "Sent to Kitchen",
          status_preparing: "Preparing",
          status_ready: "Ready to Serve",
          status_served: "Served",
          status_payment: "Waiting Payment",
          status_waiting_for_payment: "Waiting Payment",
          // Payment Breakdown
          payment_breakdown: "Payment Breakdown",
          payment_breakdown_sub: "Today's collections by payment method",
          payment_transaction: "transaction",
          payment_transactions: "transactions",
          payment_last7: "Last 7 Days",
          payment_date_col: "Date",
          payment_total_col: "Total",
          payment_today_badge: "Today",
          // Table card buttons
          btn_seat_guest: "Seat Guest",
          btn_view_order: "View Order",
          btn_take_payment: "Take Payment",
          btn_release: "Release",
        },
        so: {
          // Sidebar
          nav_dashboard: "Bogga Maamulka",
          nav_tables: "Miisaska",
          nav_menu: "Cuntooyinka",
          nav_kitchen: "Jiko",
          nav_orders: "Dalabka",
          nav_payments: "Lacag Bixinta",
          nav_settings: "Goobaha",
          nav_logout: "Ka Bax",
          dark_mode: "Muuqaalka Madow",
          // POS Cart
          current_order: "Dalabka Hadda",
          dine_in: "Dalabka Macamiilka ",
          sub_total: "Wadarta Hoose",
          tax: "Canshuurta 5%",
          total_amount: "Wadarta Guud",
          pay_cash: "Kaash",
          pay_card: "Zaad",
          pay_qr: "E-dahab",
          send_to_kitchen: "U Dir Jikada",
          recall_order: "Dib u Soo Qaad",
          waiting_chef: "Sugaya Kariyaha...",
          pay_print: "Bixi & Daabac",
          view_order: "Fiiri Dalabka",
          total: "Wadarta",
          search_placeholder: "Raadi Alaab...",
          // Tables View
          tables_title: "Adeegga Miisaska",
          tables_subtitle:
            "Dooro miis si aad u bilawdo ama u maamusho dalabyada.",
          table_status_available: "Banaan",
          table_status_occupied: "Waa La Qaatay",
          table_status_kitchen: "Jiko/Diyaar",
          table_status_payment: "Sugaya Lacag Bixinta",
          table_btn_select: "Dooro Miiska",
          table_btn_open: "Fur",
          table_empty_cart: "Baarkiilka waa faaruq",
          add_table: "Kudar Miis",
          table_added: "Miis cusub si guul leh ayaa loogu daray!",
          prompt_add_tables:
            "Immiso miisas ayaad jeclaan lahayd inaad ku dartid?",
          toast_invalid_number: "Fadlan geli lambar sax ah.",
          // Kitchen View
          kitchen_title: "Jikada",
          kitchen_sent: "Loo Diray Jikada",
          kitchen_preparing: "Diyaarinta",
          kitchen_new_badge: "Dalab Cusub",
          kitchen_start: "Bilow Diyaarinta",
          kitchen_mark_ready: "Diyaar",
          ready_to_serve: "Waa diyaar Cuntadu",

          kitchen_all_done: "Dhammaan dalabyadu way dhammaadeen",
          // Admin Dashboard
          admin_title: "Bogga Maamulka",
          admin_subtitle: "Guudmar maanta ah",
          admin_live: "Toos ah",
          admin_refresh: "Cusboonaysii",
          admin_revenue: "Dakhliga Guud",
          admin_orders: "Dalabka Guud",
          admin_avg: "Celceliska Dalabka",
          admin_staff: "Shaqaalaha Jooga",
          admin_chart_title: "Dakhliga Bilaha ah",
          admin_chart_sub: "7 Maalmood ee la soo Dhaafay",
          admin_days7: "7 Maalmood",
          admin_top_waiters: "Kababyada Ugu Fiican",
          admin_top_rank: "Liiska Maanta",
          admin_team: "Maaraynta Shaqaalaha",
          admin_team_sub: "Shaqaalahaaga maamul",
          admin_add_staff: "Kudar Shaqaale",
          admin_no_waiters: "Wali dalab maanta ma jiro.",
          admin_no_staff: "Shaqaale lama helin.",
          // Orders View
          orders_title: "Diiwaanka Dalabka",
          orders_subtitle:
            "La soco oo maamul dhammaan macaamiladii dhammaaday.",
          orders_col_details: "Faahfaahinta Dalabka",
          orders_col_assigned: "Loo Xilsaaray",
          orders_col_summary: "Koobaynta Dalabka",
          orders_col_amount: "Lacagta La Bixiyay",
          orders_col_time: "Wakhtiga",
          orders_col_print: "Daabac",
          orders_paid: "La Bixiyay",
          orders_empty: "Wali dalabyo dhammaaday maanta ma jiraan.",
          orders_items: "Badeecooyin",
          orders_live_sync: "Toos ah Isku xidhka",
          // Receipt Modal
          receipt_cancel: "Jooji",
          receipt_pay_print: "Bixi & Daabac",
          receipt_close: "Xidh",
          receipt_print: "Daabac Rasiidhka",
          // Settings
          settings_title: "Goobaha",
          settings_appearance: "Muuqaalka",
          settings_dark_mode: "Muuqaalka Madow",
          settings_dark_sub: "Beddel muuqaalka ifka ama madowga",
          settings_lang: "Luqadda",
          settings_lang_sub: "Dooro luqadda aad doorbideyso",
          // Staff Table
          staff_name: "Magaca",
          staff_role: "Doorka",
          staff_status: "Xaaladda",
          staff_actions: "Ficilada",
          // Add Staff Modal
          modal_add_staff: "Kudar Shaqaale Cusub",
          modal_edit_staff: "Beddel Shaqaalaha",
          modal_fill_details: "Buuxi foomka hoose",

          modal_full_name: "Magaca Buuxa",
          modal_role: "Doorka",
          modal_pin: "Lambarka Sirta",
          modal_status: "Xaaladda",
          modal_cancel: "Jooji",
          modal_save: "Keydi Isbedelada",
          modal_add_btn: "Kudar Xubin Shaqo",
          // Notifications
          notif_order_ready: "Dalabku Waa Diyaar",
          notif_mark_read: "Dhammaan Calaamadi in la aqriyay",
          // General
          close: "Xidh",
          cancel: "Jooji",
          save: "Keydi",
          edit: "Baddel",
          delete: "Tirtir",
          active: "Shaqeynaya",
          inactive: "Ma Shaqeeynayo",
          // Roles
          role_admin: "Maamule-Guud",
          role_manager: "Maamule",
          role_waiter: "Mudalab",
          role_chef: "Kariye",
          role_cashier: "Qasnaji",
          today: "Maanta",
          avg: "Cels",
          orders_badge: "Dalabyo",
          live_badge: "Toos ah",
          // Toast Messages
          toast_title_success: "Guul",
          toast_title_error: "Loo Diiday",
          toast_title_info: "Ogeysiis",
          toast_title_warning: "Digniin",
          toast_select_table: "Fadlan dooro miis marka hore",
          toast_recalled: "Dalabkii dib baa loo celiyay.",
          toast_kitchen_waiting: "Dalabku wuxuu ku jiraa safka jikada.",
          toast_sent_kitchen: "Dalabka jikada ayaa loo diray!",
          toast_paid: "Lacag bixinta waa guuleysatay!",
          toast_table_occupied: "Miiskan waxaa Qaatay.",
          toast_staff_added: "Shaqaalaha waa lagu daray.",
          toast_staff_updated: "Shaqaalaha waa la cusbooneysiiyay.",
          toast_staff_deleted: "Shaqaalaha waa la tirtiray.",
          toast_order_ready: "Dalabku waa diyaar in la adeego!",
          toast_add_items: "Fadlan alaab ku dar baarkiilka marka hore.",
          toast_fill_fields: "Fadlan buuxi dhammaan meelaha loo baahan yahay.",
          toast_no_recent_orders:
            "Wax dalab ah oo miiskan hadda lagama helin si loo furo.",
          toast_order_too_old:
            "Dalabkii u dambeeyay aad buu u duugoobay si loo furo (2 saacadood ka badan).",
          toast_table_restored:
            "Miiska {id} waxaa lagu soo celiyay XISAAB SUGID.",
          confirm_reopen:
            "Maamulaha: Ma rabtaa inaad dib u furto dalabkii ugu dambeeyay ee {id}? Wadarta guud waxay ahayd ${total}.",
          toast_admin_only:
            "Kaliya Maamulaha ayaa maamuli kara alaabta menu-ka.",
          toast_enter_name: "Fadlan geli magaca alaabta.",
          toast_enter_price: "Fadlan geli qiimo sax ah.",
          toast_select_category: "Fadlan dooro qayb (category).",
          toast_item_updated: "Alaabta waa la cusbooneysiiyay si guul leh!",
          toast_item_added: "Alaabta waa lagu daray si guul leh!",
          toast_item_deleted: "Alaabta waa la tirtiray.",
          toast_cannot_modify_sent: "Ma baddeli kartid dalab loo diray jikada.",
          toast_cannot_release_kitchen:
            "Ma sii deyn kartid miis dalabkiisu jikada ku jiro.",
          toast_no_permission_release:
            "Ma haysatid ogolaansho aad ku sii deyso miiskan.",
          toast_table_released: "Miiska si guul leh ayaa loo sii daayay.",
          toast_order_served: "Dalabka waxaa lagu calaamadeeyay in la adeegay.",
          toast_order_fully_paid:
            "Dalabka waa la wada bixiyay. Miiska waa la sii deynayaa...",
          toast_in_kitchen: "Dalabka hadda jikada ayuu ku jiraa.",
          toast_remote_release:
            "Miiska meel fog ayaa laga sii daayay. Dib ayaa laguugu celinayaa...",
          confirm_remove_staff: "Ma hubtaa inaad tirtirto shaqaalahan?",
          confirm_delete_item: "Ma hubtaa inaad alaabtan tirtirto weligeed?",
          alert_admin_only_delete:
            "Kaliya Maamulayaasha ayaa tirtiri kara shaqaalaha.",
          // Release Modal
          release_title: "Siidaa miiskan",
          release_confirm_msg: "Ma hubtaa  inaad Siidayso miiskan?",
          release_confirm_sub: "Dalabkani Hawada Ayuu Kabaxayaa .",
          release_keep: "Sii Hay Miiska",
          release_yes: "Haa, Siidaa",
          // Table card buttons Labels
          status_available: "Banaan",
          status_occupied: "La Qaatay",
          status_sending: "Waa la dirayaa...",
          status_sent: "Loo Diray Jikada",
          status_preparing: "Diyaarinta",
          status_ready: "Diyaar",
          status_served: "Loo Shaqeeyay",
          status_payment: "Sugaya Lacag Bixinta",
          status_waiting_for_payment: "Sugaya Lacag Bixinta",
          // Payment Breakdown
          payment_breakdown: "Kala-saarista Lacag-bixinta",
          payment_breakdown_sub: "Lacagaha maanta  iyo Sida loo kala qaaday",
          payment_transaction: "macaamilad",
          payment_transactions: "macaamiladood",
          payment_last7: "7 Maalmood ee la soo dhaafay",
          payment_date_col: "Taariikhda",
          payment_total_col: "Wadarta",
          payment_today_badge: "Maanta",
          // Table card buttons
          btn_seat_guest: "Fadhiisi Martida",
          btn_view_order: "Fiiri Dalabka",
          btn_take_payment: "Qaado Lacagta",
          btn_release: "Siidaa Miiska",
        },
      };

      function t(key) {
        return (
          (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) ||
          TRANSLATIONS["en"][key] ||
          key
        );
      }

      function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("hudheel_lang", lang);
        applyLanguage();
      }

      function applyLanguage() {
        // Update all elements with data-i18n attribute
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          el.innerText = t(key);
        });
        // Update placeholder attributes
        document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
          el.placeholder = t(el.getAttribute("data-i18n-placeholder"));
        });
        // Update language toggle button styles
        const enBtn = document.getElementById("lang-btn-en");
        const soBtn = document.getElementById("lang-btn-so");
        const setEnBtn = document.getElementById("lang-btn-settings-en");
        const setSoBtn = document.getElementById("lang-btn-settings-so");

        if (enBtn && soBtn) {
          if (currentLang === "en") {
            enBtn.className =
              "flex-1 py-1.5 text-xs font-extrabold rounded-lg bg-primary text-white transition-all shadow-sm";
            soBtn.className =
              "flex-1 py-1.5 text-xs font-extrabold rounded-lg text-gray-400 dark:text-gray-400 hover:text-gray-700 transition-all";
          } else {
            soBtn.className =
              "flex-1 py-1.5 text-xs font-extrabold rounded-lg bg-primary text-white transition-all shadow-sm";
            enBtn.className =
              "flex-1 py-1.5 text-xs font-extrabold rounded-lg text-gray-400 dark:text-gray-400 hover:text-gray-700 transition-all";
          }
        }

        if (setEnBtn && setSoBtn) {
          if (currentLang === "en") {
            setEnBtn.className =
              "flex-1 rounded-2xl text-white font-bold text-xl transition-all bg-primary shadow-md tracking-wide";
            setSoBtn.className =
              "flex-1 rounded-2xl text-gray-500 dark:text-gray-300 font-bold text-xl hover:text-gray-800 dark:hover:text-white transition-all tracking-wide";
          } else {
            setSoBtn.className =
              "flex-1 rounded-2xl text-white font-bold text-xl transition-all bg-primary shadow-md tracking-wide";
            setEnBtn.className =
              "flex-1 rounded-2xl text-gray-500 dark:text-gray-300 font-bold text-xl hover:text-gray-800 dark:hover:text-white transition-all tracking-wide";
          }
        }
        // Re-render dynamic views if they are currently visible
        if (typeof setupNav === "function" && window._navSetupDone) setupNav();
        if (typeof renderOrderHistory === "function") renderOrderHistory();
        if (
          typeof renderAdmin === "function" &&
          !document.getElementById("view-admin").classList.contains("hidden")
        )
          renderAdmin();
        if (
          typeof renderKitchen === "function" &&
          !document.getElementById("view-kitchen").classList.contains("hidden")
        )
          renderKitchen();
        if (typeof renderTablesView === "function") renderTablesView();
        if (typeof updateMainActionButton === "function")
          updateMainActionButton();
        // Always re-render staff table so Active/Inactive labels update on language change
        if (
          typeof renderStaffTable === "function" &&
          document.getElementById("staff-table-body")
        )
          renderStaffTable();
      }

      const STATUS = {
        AVAILABLE: "Available",
        OCCUPIED: "Occupied", // Draft state
        SENT_WAITING_RECALL: "Sending...", // Waiter 30s grace period
        SENT: "Sent to Kitchen",
        PREPARING: "Preparing",
        READY: "Ready to Serve",
        SERVED: "Served",
        WAITING_PAYMENT: "Waiting for Payment",
      };

      // --- TABLE DATA (Upgraded) ---
      let activeTableId = null; // Changed from 'T4' so Waiters must select a table first
      let tables = [
        {
          id: "T1",
          name: "Available",
          status: STATUS.AVAILABLE,
          bg: "bg-gray-100",
          text: "text-gray-400",
          cart: [],
          lockedBy: null,
          waiterName: null,
          openedAt: null,
          timestamps: {},
          recallTimer: null,
          recallRemaining: 0,
          payRecords: [],
        },
        {
          id: "T2",
          name: "Available",
          status: STATUS.AVAILABLE,
          bg: "bg-gray-100",
          text: "text-gray-400",
          cart: [],
          lockedBy: null,
          waiterName: null,
          openedAt: null,
          timestamps: {},
          recallTimer: null,
          recallRemaining: 0,
          payRecords: [],
        },
        {
          id: "T3",
          name: "Available",
          status: STATUS.AVAILABLE,
          bg: "bg-gray-100",
          text: "text-gray-400",
          cart: [],
          lockedBy: null,
          waiterName: null,
          openedAt: null,
          timestamps: {},
          recallTimer: null,
          recallRemaining: 0,
          payRecords: [],
        },
        {
          id: "T4",
          name: "Available",
          status: STATUS.AVAILABLE,
          bg: "bg-gray-100",
          text: "text-gray-400",
          cart: [],
          lockedBy: null,
          waiterName: null,
          openedAt: null,
          timestamps: {},
          recallTimer: null,
          recallRemaining: 0,
          payRecords: [],
        },
        {
          id: "T5",
          name: "Available",
          status: STATUS.AVAILABLE,
          bg: "bg-gray-100",
          text: "text-gray-400",
          cart: [],
          lockedBy: null,
          waiterName: null,
          openedAt: null,
          timestamps: {},
          recallTimer: null,
          recallRemaining: 0,
          payRecords: [],
        },
        {
          id: "T6",
          name: "Available",
          status: STATUS.AVAILABLE,
          bg: "bg-gray-100",
          text: "text-gray-400",
          cart: [],
          lockedBy: null,
          waiterName: null,
          openedAt: null,
          timestamps: {},
          recallTimer: null,
          recallRemaining: 0,
          payRecords: [],
        },
      ];

      let activeCategory = "all";
      let currentOrderId = 2034;
      let selectedPayment = "Cash";

      // --- DATA ---
      /*
             RECOMMENDED ICONS FOR FUTURE CATEGORIES:
             - Pizza: fa-pizza-slice
             - Grill: fa-drumstick-bite
             - Drinks: fa-glass-water, fa-coffee, fa-bottle-water, fa-wine-glass
             - Dessert: fa-ice-cream, fa-cookie, fa-cake-candles
             - Seafood: fa-fish, fa-shrimp
             - Healthy: fa-carrot, fa-apple-whole, fa-seedling
             - Ethnic: fa-bowl-rice, fa-pepper-hot
             - Bakery: fa-bread-slice, fa-croissant
          */
      let categories = JSON.parse(localStorage.getItem("pos_categories")) || [
        { id: "all", name: "All", count: 0, icon: "fa-table-cells-large" },
        { id: "breakfast", name: "Breakfast", count: 0, icon: "fa-egg" },
        { id: "soups", name: "Soups", count: 0, icon: "fa-mug-hot" },
        { id: "pasta", name: "Pasta", count: 0, icon: "fa-utensils" },
        { id: "main", name: "Main Course", count: 0, icon: "fa-bowl-food" },
        { id: "burger", name: "Burgers", count: 0, icon: "fa-burger" },
        { id: "pizza", name: "Pizza", count: 0, icon: "fa-pizza-slice" },
        { id: "desserts", name: "Desserts", count: 0, icon: "fa-ice-cream" },
        { id: "drinks", name: "Drinks", count: 0, icon: "fa-glass-water" },
        { id: "seafood", name: "Seafood", count: 0, icon: "fa-fish" },
      ];

      let products = JSON.parse(localStorage.getItem("pos_products")) || [
        {
          id: 1,
          name: "Original Chess Meat Burger With Chips",
          price: 23.99,
          category: "burger",
          image:
            "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=400",
        },
        {
          id: 2,
          name: "Fresh Orange Juice With Basil Seed",
          price: 12.99,
          category: "breakfast",
          image:
            "https://images.unsplash.com/photo-1613478223719-2ab802602423?q=80&w=400",
        },
        {
          id: 3,
          name: "Meat Sushi Maki With Tuna",
          price: 9.99,
          category: "main",
          image:
            "https://images.unsplash.com/photo-1579871494447-9811cf80d66c?q=80&w=400",
        },
        {
          id: 4,
          name: "Tacos Salsa With Chickens Grilled",
          price: 14.99,
          category: "main",
          image:
            "https://images.unsplash.com/photo-1565299585323-38d6b0865b47?q=80&w=400",
        },
        {
          id: 5,
          name: "Tasty Vegetable Salad Healthy",
          price: 17.99,
          category: "soups",
          image:
            "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=400",
        },
        {
          id: 6,
          name: "Original Chess Burger With French Fries",
          price: 10.59,
          category: "burger",
          image:
            "https://images.unsplash.com/photo-1551782450-a2132b4ba21d?q=80&w=400",
        },
      ];

      let kitchenOrders = [];
      let pendingNotifications = []; // For simulating real-time alerts
      let orderHistory = []; // Paid orders history
      let auditLog = []; // Structural changes (cancels, overrides, etc)

      // --- DATA PERSISTENCE (LocalStorage) ---
      function loadData() {
        const savedTables = localStorage.getItem("pos_tables");
        const savedKitchen = localStorage.getItem("pos_kitchen");
        const savedHistory = localStorage.getItem("pos_history");
        const savedAudit = localStorage.getItem("pos_audit");
        const savedOrderId = localStorage.getItem("pos_order_id");

        if (savedTables) {
          const parsedTables = JSON.parse(savedTables);
          // Rebuilds the ENTIRE table list so new tables aren't ignored
          tables = parsedTables.map((pt) => {
            if (
              pt.status === "Sending..." ||
              (pt.status === "Sent to Kitchen" && pt.recallRemaining > 0)
            ) {
              pt.status = "Occupied";
              pt.recallRemaining = 0;
            }
            return { ...pt, recallTimer: null };
          });
        }
        if (savedKitchen) kitchenOrders = JSON.parse(savedKitchen);
        if (savedHistory) orderHistory = JSON.parse(savedHistory);
        if (savedAudit) auditLog = JSON.parse(savedAudit);
        if (savedOrderId) currentOrderId = parseInt(savedOrderId);
      }
      function saveData() {
        const tablesToSave = tables.map((t) => {
          const { recallTimer, ...rest } = t;
          return rest;
        });

        // 1. Save to Local Hard Drive
        localStorage.setItem("pos_tables", JSON.stringify(tablesToSave));
        localStorage.setItem("pos_kitchen", JSON.stringify(kitchenOrders));
        localStorage.setItem("pos_history", JSON.stringify(orderHistory));
        localStorage.setItem("pos_audit", JSON.stringify(auditLog));
        localStorage.setItem("pos_order_id", currentOrderId.toString());
        localStorage.setItem("pos_staff", JSON.stringify(staffList));
        localStorage.setItem("pos_products", JSON.stringify(products));

        // 2. Radio the Updates to All Other Devices (Walkie-Talkie)
        if (typeof socket !== "undefined") {
          if (activeTableId) {
            const currentTable = tables.find((t) => t.id === activeTableId);
            if (currentTable) socket.emit("update_table", currentTable);
          }
          socket.emit("broadcast_history", orderHistory);
          socket.emit("broadcast_staff", staffList);
          socket.emit("broadcast_products", products);
        }
      }

      // LIVE SYNC: Tell the Mac a table or cart just updated!
      socket.on("sync_history", (newHistory) => {
        if (newHistory && newHistory.length > 0) {
          orderHistory = newHistory;
          localStorage.setItem("pos_history", JSON.stringify(orderHistory));
          if (
            !document.getElementById("view-admin").classList.contains("hidden")
          )
            renderAdmin();
          if (
            !document.getElementById("view-orders").classList.contains("hidden")
          )
            renderOrderHistory();
        }
      });

      // Listen for Staff Updates from other devices
      socket.on("sync_staff", (newStaff) => {
        if (newStaff && newStaff.length > 0) {
          staffList = newStaff;
          localStorage.setItem("pos_staff", JSON.stringify(staffList));
          if (
            !document.getElementById("view-admin").classList.contains("hidden")
          )
            renderStaffTable();

          // Update login dropdown if someone is currently looking at the login screen
          const userSelect = document.getElementById("login-user-select");
          if (userSelect && selectedRole) selectLoginRole(selectedRole);
        }
      });

      // Listen for Product Updates from other devices
      socket.on("sync_products", (newProducts) => {
        if (newProducts && newProducts.length > 0) {
          products = newProducts;
          localStorage.setItem("pos_products", JSON.stringify(products));
          if (!document.getElementById("view-pos").classList.contains("hidden"))
            renderMenu();
        }
      });

      // Wrap state changers to auto-save
      const originalClearInterval = window.clearInterval;

      // Load immediately
      loadData();

      // --- AUTO-RESUME SESSION ---
      function restoreSession() {
        const savedUserId = localStorage.getItem("lastLoggedInUserId");
        if (savedUserId) {
          const userToLogin = staffList.find((u) => u.id == savedUserId);
          if (userToLogin) {
            currentUser = userToLogin;

            // Hide login, show app
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("app-container").classList.remove("hidden");
            document.getElementById("user-name-display").innerText =
              currentUser.name;
            document.getElementById("user-role-label").innerText =
              currentUser.role;
            document.getElementById("user-avatar").src =
              `https://ui-avatars.com/api/?name=${currentUser.avatar || currentUser.name.replace(" ", "+")}&background=10B981&color=fff`;

            if (currentUser.role === "Admin") {
              document
                .getElementById("add-product-btn")
                .classList.remove("hidden");
            } else {
              document
                .getElementById("add-product-btn")
                .classList.add("hidden");
            }

            // Setup the UI
            setupNav();
            applyLanguage();
            renderCategories();

            // Go to the exact screen they were looking at before refreshing!
            const savedView = localStorage.getItem("lastActiveView");
            if (savedView) {
              switchView(savedView);
            } else {
              // Fallback routing if no screen was saved
              if (["Admin", "Manager"].includes(currentUser.role))
                switchView("admin");
              else if (currentUser.role === "Waiter") switchView("tables");
              else if (currentUser.role === "Chef") switchView("kitchen");
              else if (currentUser.role === "Cashier") switchView("orders");
              else switchView("pos");
            }
          }
        }
      }

      restoreSession(); // Run it immediately on page load!

      // --- LOGIN FUNCTIONS ---
      // Attach event listeners defensively once DOM is parsed
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".role-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const role = btn.getAttribute("data-role");
            console.log("Role clicked via EventListener:", role);
            if (role) selectLoginRole(role);
          });
        });
      });

      function selectLoginRole(role) {
        console.log("selectLoginRole executed for:", role);
        selectedRole = role;

        const userSelect = document.getElementById("login-user-select");
        const userContainer = document.getElementById(
          "user-selection-container",
        );

        // Filter staff by role
        const filteredStaff = staffList.filter(
          (u) => u.role.toLowerCase() === role.toLowerCase(),
        );

        // Populate dropdown
        userSelect.innerHTML =
          '<option value="" disabled selected>Choose your account</option>';
        filteredStaff.forEach((u) => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name;
          userSelect.appendChild(opt);
        });

        // Logic: If there's only one user in this role (like Admin), skip the dropdown.
        if (filteredStaff.length === 1) {
          userSelect.value = filteredStaff[0].id; // Auto-select the only user
          userContainer.classList.add("hidden"); // Hide the dropdown
        } else {
          userContainer.classList.remove("hidden"); // Show for Waiters etc.
        }

        document.querySelectorAll(".role-btn").forEach((btn) => {
          const isActive = btn.dataset.role === role;
          btn.className = isActive
            ? "role-btn p-3 md:p-4 rounded-2xl border bg-primary/5 border-primary flex flex-col items-center gap-2 md:gap-3 transition-all cursor-pointer"
            : "role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer";
          const iconDiv = btn.querySelector("div");
          iconDiv.className = isActive
            ? "w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary text-white shadow-sm flex items-center justify-center transition-colors text-sm md:text-base pointer-events-none"
            : "w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base pointer-events-none";
          btn.querySelector("span").className = isActive
            ? "text-xs md:text-sm font-bold text-primary-dark pointer-events-none"
            : "text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark pointer-events-none";
        });

        // Focus PIN after a small delay to allow animation/DOM updates
        setTimeout(() => {
          const pinInput = document.getElementById("login-pin");
          if (pinInput) pinInput.focus();
        }, 100);
      }

      function handleLogin() {
        const userId = document.getElementById("login-user-select").value;
        const pin = document.getElementById("login-pin").value;

        if (!selectedRole) return alert("Select a role first.");
        if (!userId) return alert("Please select your user account.");
        if (!pin) return alert("Enter your PIN.");

        // Find user by ID
        const userToLogin = staffList.find((u) => u.id == userId);

        if (!userToLogin || userToLogin.pin !== pin) {
          alert("Invalid PIN.");
          return;
        }

        if (userToLogin.pin === pin) {
          currentUser = userToLogin;
          localStorage.setItem("lastLoggedInUserId", currentUser.id);

          document.getElementById("login-screen").classList.add("hidden");
          document.getElementById("app-container").classList.remove("hidden");
          document.getElementById("user-name-display").innerText =
            currentUser.name;
          document.getElementById("user-role-label").innerText =
            currentUser.role;
          document.getElementById("user-avatar").src =
            `https://ui-avatars.com/api/?name=${currentUser.avatar || currentUser.name.replace(" ", "+")}&background=10B981&color=fff`;

          // Admin buttons setup
          if (currentUser.role === "Admin")
            document
              .getElementById("add-product-btn")
              .classList.remove("hidden");
          else
            document.getElementById("add-product-btn").classList.add("hidden");

          setupNav();
          applyLanguage();
          renderCategories();

          // Workflow Logic: Users land on their respective primary views
          if (window.postLoginRedirect === "tables") {
            window.postLoginRedirect = null;
            switchView("tables");
          } else if (
            currentUser.role === "Admin" ||
            currentUser.role === "Manager"
          ) {
            switchView("admin");
          } else if (currentUser.role === "Waiter") {
            switchView("tables");
          } else if (currentUser.role === "Chef") {
            switchView("kitchen");
          } else if (currentUser.role === "Cashier") {
            switchView("orders");
          } else {
            switchView("pos"); // Default view for other roles or if no specific role match
          }

          checkPendingNotifications();
          saveData(); // Save state on login
        } else {
          alert("Invalid PIN (Try 1234)");
        }
      }

      function logout() {
        currentUser = null;
        selectedRole = null;
        activeTableId = null; // Clear selected table
        document.getElementById("login-pin").value = "";
        document
          .getElementById("user-selection-container")
          .classList.add("hidden");

        localStorage.removeItem("lastLoggedInUserId"); // <--- NEW: Forgets the user
        localStorage.removeItem("lastActiveView"); // <--- NEW: Forgets the screen

        document.querySelectorAll(".role-btn").forEach((btn) => {
          btn.className =
            "role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer";
          const iconDiv = btn.querySelector("div");
          iconDiv.className =
            "w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base";
          btn.querySelector("span").className =
            "text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark";
        });

        document.getElementById("login-screen").classList.remove("hidden");
        document.getElementById("app-container").classList.add("hidden");
        // Close mobile sidebar if open
        document
          .getElementById("main-sidebar")
          .classList.add("sidebar-mobile-hidden");
        document.getElementById("sidebar-overlay").classList.add("hidden");
      }

      // --- NAVIGATION & UI ---
      function setupNav() {
        const nav = document.getElementById("nav-menu");
        let items = [];
        const role = currentUser.role;

        // New Menu Structure
        if (["Admin", "Manager"].includes(role)) {
          items.push({
            id: "admin",
            label: t("nav_dashboard"),
            icon: "fa-border-all",
          });
        }

        if (["Admin", "Manager", "Waiter"].includes(role)) {
          items.push({
            id: "tables",
            label: t("nav_tables"),
            icon: "fa-table-cells",
          });
          items.push({ id: "pos", label: t("nav_menu"), icon: "fa-utensils" });
        }

        // Kitchen limited to Chef only per request
        if (["Chef"].includes(role)) {
          items.push({
            id: "kitchen",
            label: t("nav_kitchen"),
            icon: "fa-fire-burner",
          });
        }

        if (["Admin", "Manager", "Cashier", "Waiter"].includes(role)) {
          items.push({
            id: "orders",
            label: t("nav_orders"),
            icon: "fa-clipboard-list",
          });
        }

        // Handle Settings Button Visibility â€” hidden for all users in sidebar
        const settingsBtn = document.getElementById("settings-btn");
        if (settingsBtn) {
          settingsBtn.classList.add("hidden");
        }

        window._navSetupDone = true;

        nav.innerHTML = items
          .map(
            (item) => `
                      <button onclick="switchView('${item.id}')" data-view="${item.id}" class="nav-item w-full flex items-center gap-4 px-4 py-4 rounded-xl text-gray-500 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-all font-medium group">
                          <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl transition-colors icon-container">
                              <i class="fa-solid ${item.icon}"></i>
                          </div>
                          <span>${item.label}</span>
                      </button>
                  `,
          )
          .join("");
      }

      function switchView(viewId) {
        const views = [
          "pos",
          "kitchen",
          "admin",
          "tables",
          "settings",
          "reservation",
          "receipt",
          "orders",
        ];

        // Handling Cart placeholder click to show Cart panel on mobile or focus on desktop
        if (viewId === "cart") {
          if (window.innerWidth < 1024) toggleMobileCart();
          // Close sidebar on mobile
          const sidebar = document.getElementById("main-sidebar");
          const overlay = document.getElementById("sidebar-overlay");
          sidebar.classList.add("sidebar-mobile-hidden");
          sidebar.classList.remove("sidebar-mobile-visible");
          overlay.classList.add("hidden");
          return;
        }

        // Close mobile sidebar on navigation
        const sidebar = document.getElementById("main-sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        sidebar.classList.add("sidebar-mobile-hidden");
        sidebar.classList.remove("sidebar-mobile-visible");
        overlay.classList.add("hidden");

        // Close mobile cart panel on navigation away from POS
        const cartPanel = document.getElementById("pos-cart-panel");
        if (cartPanel && cartPanel.classList.contains("cart-mobile-visible")) {
          cartPanel.classList.remove("cart-mobile-visible");
          cartPanel.classList.add("cart-mobile-hidden");
        }

        // Waiter routing logic: If no table active, they shouldn't access Menu directly
        if (
          viewId === "pos" &&
          (!activeTableId ||
            tables.find((t) => t.id === activeTableId)?.status === "Available")
        ) {
          showToast(t("toast_select_table"), "warning");
          viewId = "tables";
        }

        if (views.includes(viewId)) {
          views.forEach((v) =>
            document.getElementById(`view-${v}`).classList.add("hidden"),
          );
          document.getElementById(`view-${viewId}`).classList.remove("hidden");

          localStorage.setItem("lastActiveView", viewId); // <--- NEW: Remembers the screen!

          // Show view-specific layouts

          if (viewId === "admin") {
            renderAdmin();
            renderStaffTable();
          }
          if (viewId === "orders") renderOrderHistory();
          if (viewId === "kitchen") renderKitchen();
          if (viewId === "tables") renderTablesView();

          if (viewId === "pos") {
            renderMenu();
            renderCart();
          }

          // Hide mobile cart button if leaving POS
          if (viewId !== "pos")
            document.getElementById("mobile-cart-btn").classList.add("hidden");
          else updateMobileCartButton();
        }

        document.querySelectorAll(".nav-item").forEach((btn) => {
          const iconDiv = btn.querySelector(".icon-container");
          if (btn.dataset.view === viewId) {
            btn.classList.add(
              "bg-primary",
              "text-white",
              "shadow-lg",
              "shadow-primary/30",
            );
            btn.classList.remove(
              "text-gray-500",
              "hover:text-primary",
              "dark:text-gray-300",
              "dark:hover:text-primary",
            );
            iconDiv.classList.add("bg-white/20", "text-white");
            iconDiv.classList.remove(
              "bg-gray-50",
              "dark:bg-gray-700",
              "group-hover:bg-primary",
              "group-hover:text-white",
            );
          } else {
            btn.classList.remove(
              "bg-primary",
              "text-white",
              "shadow-lg",
              "shadow-primary/30",
            );
            btn.classList.add(
              "text-gray-500",
              "hover:text-primary",
              "dark:text-gray-300",
              "dark:hover:text-primary",
            );
            iconDiv.classList.remove("bg-white/20", "text-white");
            iconDiv.classList.add(
              "bg-gray-50",
              "dark:bg-gray-700",
              "group-hover:bg-primary",
              "group-hover:text-white",
            );
          }
        });

        // Handle footer buttons active state (Settings)
        if (viewId === "settings") {
          const settingsBtn = document.getElementById("settings-btn");
          if (settingsBtn) {
            const iconDiv = settingsBtn.querySelector(".icon-container");
            settingsBtn.classList.add(
              "bg-primary",
              "text-white",
              "shadow-lg",
              "shadow-primary/30",
            );
            settingsBtn.classList.remove(
              "text-gray-500",
              "hover:text-primary",
              "dark:text-gray-300",
              "dark:hover:text-primary",
            );
            iconDiv.classList.add("bg-white/20", "text-white");
          }
        } else {
          const settingsBtn = document.getElementById("settings-btn");
          if (settingsBtn) {
            const iconDiv = settingsBtn.querySelector(".icon-container");
            settingsBtn.classList.remove(
              "bg-primary",
              "text-white",
              "shadow-lg",
              "shadow-primary/30",
            );
            settingsBtn.classList.add(
              "text-gray-500",
              "hover:text-primary",
              "dark:text-gray-300",
              "dark:hover:text-primary",
            );
            iconDiv.classList.remove("bg-white/20", "text-white");
          }
        }
      }

      // --- DASHBOARD LOGIC (ADMIN CONTENT) ---
      let adminChart = null;

      function renderAdmin() {
        // 1. Calculate Today's Metrics
        const today = new Date().toLocaleDateString();
        const todaysOrders = orderHistory.filter(
          (o) => new Date(o.timestamps.paid).toLocaleDateString() === today,
        );

        // Update date display pill
        const dateEl = document.getElementById("admin-date-display");
        if (dateEl)
          dateEl.innerText = new Date().toLocaleDateString([], {
            weekday: "short",
            month: "long",
            day: "numeric",
          });

        const totalRevenue = todaysOrders.reduce((sum, o) => sum + o.total, 0);
        const orderCount = todaysOrders.length;
        const avgOrder = orderCount > 0 ? totalRevenue / orderCount : 0;
        const activeStaff = staffList.filter(
          (s) => s.status === "Active",
        ).length;

        // 2. Update DOM Metric Cards
        document.getElementById("admin-revenue").innerText =
          `$${totalRevenue.toFixed(2)}`;
        document.getElementById("admin-orders").innerText = orderCount;
        document.getElementById("admin-avg-order").innerText =
          `$${avgOrder.toFixed(2)}`;
        document.getElementById("active-staff-count").innerText = activeStaff;

        // 3. Render Chart.js
        const ctx = document.getElementById("salesChart");
        if (!ctx) return;

        // Generate last 7 days labels
        const labels = [];
        const dataPoints = [];

        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          labels.push(
            d.toLocaleDateString([], { weekday: "short", day: "numeric" }),
          );

          // If it's today, use real revenue, otherwise generate visual dummy data for the mockup
          if (i === 0) {
            dataPoints.push(totalRevenue);
          } else {
            // Dummy data between $300 and $1200 for presentation
            dataPoints.push(Math.floor(Math.random() * 900) + 300);
          }
        }

        if (adminChart) {
          adminChart.destroy();
        }

        Chart.defaults.font.family = '"Plus Jakarta Sans", sans-serif';
        Chart.defaults.color = "#9CA3AF"; // text-gray-400

        adminChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Daily Revenue ($)",
                data: dataPoints,
                backgroundColor: "#10B981",
                borderRadius: 8,
                borderSkipped: false,
                barThickness: "flex",
                maxBarThickness: 40,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "#1F2937",
                padding: 12,
                titleFont: { size: 14, weight: "bold" },
                bodyFont: { size: 14 },
                callbacks: {
                  label: function (context) {
                    return " $" + context.raw.toFixed(2);
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(156, 163, 175, 0.1)",
                  drawBorder: false,
                },
                ticks: {
                  callback: function (value) {
                    return "$" + value;
                  },
                },
              },
              x: {
                grid: { display: false },
                ticks: { maxRotation: 0, minRotation: 0 },
              },
            },
          },
        });

        // 4. Compute Top Waiters
        const waiterStats = {};
        todaysOrders.forEach((o) => {
          const wName = o.waiter || "Unknown Waiter";
          if (!waiterStats[wName]) waiterStats[wName] = 0;
          waiterStats[wName]++;
        });

        // Sort waiters by highest volume
        const sortedWaiters = Object.entries(waiterStats)
          .map(([name, count]) => ({ name, count }))
          .sort((a, b) => b.count - a.count)
          .slice(0, 3); // Top 3

        const topWaitersList = document.getElementById("top-waiters-list");
        if (topWaitersList) {
          if (sortedWaiters.length === 0) {
            topWaitersList.innerHTML = `<li class="flex items-center justify-center h-full text-gray-400 text-sm font-medium">No orders yet today</li>`;
          } else {
            topWaitersList.innerHTML = sortedWaiters
              .map((w, index) => {
                const rankColors = [
                  "text-yellow-500",
                  "text-gray-400",
                  "text-amber-700",
                ];
                const badgeBg = [
                  "bg-yellow-50 dark:bg-yellow-900/20",
                  "bg-gray-50 dark:bg-gray-800",
                  "bg-amber-50 dark:bg-amber-900/20",
                ];
                const rankStyle =
                  index < 3 ? rankColors[index] : "text-gray-400";
                const bgStyle = index < 3 ? badgeBg[index] : "";
                const avatarSafe = w.name.replace(" ", "+");

                return `
                       <li class="flex items-center p-3 rounded-2xl border border-gray-100 dark:border-gray-600/50 bg-white dark:bg-gray-800/50 hover:bg-surface dark:hover:bg-gray-700 transition-colors">
                          <div class="w-8 h-8 rounded-full font-bold flex items-center justify-center mr-3 ${bgStyle} ${rankStyle}">
                             #${index + 1}
                          </div>
                          <img src="https://ui-avatars.com/api/?name=${avatarSafe}&background=random&color=fff" class="w-10 h-10 rounded-full shadow-sm mr-3">
                          <div class="flex-1">
                             <p class="font-bold text-sm text-gray-800 dark:text-white leading-tight">${w.name}</p>
                          </div>
                          <div class="text-right">
                             <p class="font-black text-lg text-primary">${w.count}</p>
                             <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Orders</p>
                          </div>
                       </li>
                     `;
              })
              .join("");
          }
        }
        renderPaymentSummary();
      }

      // --- PAYMENT METHOD SUMMARY (Admin/Manager) ---
      function renderPaymentSummary() {
        const container = document.getElementById("payment-summary-section");
        if (!container) return;

        const methods = ["Cash", "Zaad", "E-dahab"];
        const methodColors = {
          Cash: {
            bg: "from-emerald-500 to-green-600",
            icon: "fa-money-bill",
            shadow: "shadow-emerald-500/30",
            light:
              "bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
          },
          Zaad: {
            bg: "from-blue-500 to-cyan-600",
            icon: "fa-mobile-screen-button",
            shadow: "shadow-blue-500/30",
            light:
              "bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",
          },
          "E-dahab": {
            bg: "from-orange-400 to-amber-500",
            icon: "fa-mobile-screen-button",
            shadow: "shadow-orange-400/30",
            light:
              "bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400",
          },
        };
        // Translated display names for each method
        const methodLabels = {
          Cash: t("pay_cash"),
          Zaad: t("pay_card"),
          "E-dahab": t("pay_qr"),
        };

        // --- Today's breakdown ---
        const today = new Date().toLocaleDateString();
        const todaysOrders = orderHistory.filter(
          (o) => new Date(o.timestamps.paid).toLocaleDateString() === today,
        );

        const todayStats = {};
        methods.forEach((m) => {
          todayStats[m] = { count: 0, total: 0 };
        });
        todaysOrders.forEach((o) => {
          const m = o.payments && o.payments[0] ? o.payments[0].method : "Cash";
          if (!todayStats[m]) todayStats[m] = { count: 0, total: 0 };
          todayStats[m].count++;
          todayStats[m].total += o.total;
        });

        // --- Last 7 days breakdown ---
        const weekly = {};
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const key = d.toLocaleDateString();
          const label = d.toLocaleDateString([], {
            weekday: "short",
            month: "short",
            day: "numeric",
          });
          weekly[key] = { label, Cash: 0, Zaad: 0, "E-dahab": 0 };
        }
        orderHistory.forEach((o) => {
          const key = new Date(o.timestamps.paid).toLocaleDateString();
          if (!weekly[key]) return;
          const m = o.payments && o.payments[0] ? o.payments[0].method : "Cash";
          if (weekly[key][m] !== undefined) weekly[key][m] += o.total;
        });

        // Render
        container.innerHTML = `
                <div class="mb-6">
                  <h3 class="text-xl font-black text-gray-800 dark:text-white mb-1 flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-primary"></i> ${t("payment_breakdown")}
                  </h3>
                  <p class="text-sm text-gray-400">${t("payment_breakdown_sub")}</p>
                </div>

                <!-- Today Cards -->
                <div class="grid grid-cols-3 gap-4 mb-8">
                  ${methods
                    .map((m) => {
                      const s = todayStats[m] || { count: 0, total: 0 };
                      const c = methodColors[m];
                      const txLabel =
                        s.count !== 1
                          ? t("payment_transactions")
                          : t("payment_transaction");
                      return `
                    <div class="relative bg-gradient-to-br ${c.bg} rounded-2xl p-5 text-white overflow-hidden shadow-lg ${c.shadow}">
                      <div class="absolute -top-4 -right-4 w-20 h-20 bg-white/10 rounded-full"></div>
                      <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3 backdrop-blur-sm">
                        <i class="fa-solid ${c.icon} text-lg"></i>
                      </div>
                      <p class="text-xs font-bold uppercase tracking-wider text-white/70 mb-1">${methodLabels[m]}</p>
                      <p class="text-2xl font-black">\$${s.total.toFixed(2)}</p>
                      <p class="text-xs text-white/60 mt-1">${s.count} ${txLabel}</p>
                    </div>`;
                    })
                    .join("")}
                </div>

                <!-- Weekly Table -->
                <h4 class="text-sm font-black uppercase tracking-wider text-gray-400 mb-3">${t("payment_last7")}</h4>
                <div class="overflow-x-auto rounded-2xl border border-gray-100 dark:border-gray-700">
                  <table class="w-full text-sm text-left min-w-[480px]">
                    <thead class="bg-gray-50 dark:bg-gray-800/60">
                      <tr>
                        <th class="px-4 py-3 font-bold text-gray-500 dark:text-gray-400">${t("payment_date_col")}</th>
                        ${methods.map((m) => `<th class="px-4 py-3 font-bold text-gray-500 dark:text-gray-400 text-right">${methodLabels[m]}</th>`).join("")}
                        <th class="px-4 py-3 font-bold text-gray-500 dark:text-gray-400 text-right">${t("payment_total_col")}</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                      ${Object.values(weekly)
                        .reverse()
                        .map((day) => {
                          const rowTotal = methods.reduce(
                            (s, m) => s + (day[m] || 0),
                            0,
                          );
                          const isToday =
                            day.label ===
                            new Date().toLocaleDateString([], {
                              weekday: "short",
                              month: "short",
                              day: "numeric",
                            });
                          return `
                        <tr class="${isToday ? "bg-primary/5 dark:bg-primary/10 font-bold" : "bg-white dark:bg-gray-800"} hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                          <td class="px-4 py-3 text-gray-700 dark:text-gray-300 font-semibold">${day.label}${isToday ? ` <span class="text-[10px] bg-primary text-white px-1.5 py-0.5 rounded-full ml-1">${t("payment_today_badge")}</span>` : ""}</td>
                          ${methods.map((m) => `<td class="px-4 py-3 text-right text-gray-600 dark:text-gray-400">${day[m] > 0 ? '<span class="font-bold">$' + day[m].toFixed(2) + "</span>" : '<span class="text-gray-300 dark:text-gray-600">â€”</span>'}</td>`).join("")}
                          <td class="px-4 py-3 text-right font-black text-gray-900 dark:text-white">${rowTotal > 0 ? "$" + rowTotal.toFixed(2) : "â€”"}</td>
                        </tr>`;
                        })
                        .join("")}
                    </tbody>
                  </table>
                </div>
              `;
      }

      // --- DARK MODE LOGIC ---
      function updateDarkModeUI(isDark) {
        if (isDark) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }

        const icon = document.getElementById("dark-mode-icon");
        if (icon) {
          icon.className = isDark
            ? "fa-solid fa-sun text-xs text-amber-400"
            : "fa-solid fa-moon text-xs text-gray-500";
        }
      }

      function toggleDarkMode() {
        const isCurrentlyDark =
          document.documentElement.classList.contains("dark");
        const newDarkModeState = !isCurrentlyDark;

        localStorage.setItem(
          "hudheele_dark_mode",
          newDarkModeState ? "1" : "0",
        );
        updateDarkModeUI(newDarkModeState);
      }

      // Restore saved dark mode preference and fix the icon immediately
      (function () {
        const isDark = localStorage.getItem("hudheele_dark_mode") === "1";
        // Run immediately since the script is at the bottom of the body
        updateDarkModeUI(isDark);

        // Backup run just in case icons load late
        document.addEventListener("DOMContentLoaded", () => {
          updateDarkModeUI(isDark);
        });
      })();

      // --- STAFF MANAGEMENT ---
      function renderStaffTable() {
        // ... [Preserved exactly as previous]
        const tbody = document.getElementById("staff-table-body");
        const countEl = document.getElementById("active-staff-count");
        const addBtn = document.getElementById("add-staff-btn");

        if (currentUser.role === "Admin") addBtn.classList.remove("hidden");
        else addBtn.classList.add("hidden");

        const activeCount = staffList.filter(
          (s) => s.status === "Active",
        ).length;
        if (countEl) countEl.innerText = activeCount;

        if (!tbody) return;

        tbody.innerHTML = staffList
          .map((staff) => {
            let badgeColor = "bg-blue-100 text-blue-600";
            if (staff.role === "Manager")
              badgeColor = "bg-purple-100 text-purple-600";
            if (staff.role === "Chef")
              badgeColor = "bg-orange-100 text-orange-600";
            if (staff.role === "Admin") badgeColor = "bg-red-100 text-red-600";

            const canModify =
              currentUser.role === "Admin" && staff.role !== "Admin";
            const isSelfAdmin =
              currentUser.role === "Admin" && staff.id === currentUser.id;
            const canEdit = canModify || isSelfAdmin;
            const canDelete = canModify;

            return `
                      <tr class="border-b border-gray-100 dark:border-gray-600 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                          <td class="px-4 py-3 font-medium text-gray-800 dark:text-white">${staff.name}</td>
                          <td class="px-4 py-3">
                              <span class="px-2 py-1 rounded-lg text-xs font-bold ${badgeColor}">${t("role_" + staff.role.toLowerCase())}</span>
                          </td>
                          <td class="px-4 py-3">
                              <span class="px-2 py-1 rounded-lg text-xs font-bold ${staff.status === "Active" ? "bg-green-100 text-green-600" : "bg-gray-100 text-gray-400"}">
                                  ${staff.status === "Active" ? t("active") : t("inactive")}
                              </span>
                          </td>
                          <td class="px-4 py-3 text-right">
                              ${
                                canEdit
                                  ? `
                              <div class="flex justify-end gap-2">
                                  <button onclick="openAddStaffModal(${staff.id})" class="text-gray-400 hover:text-blue-500 transition-colors w-8 h-8 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/20 flex items-center justify-center"><i class="fa-solid fa-pen"></i></button>
                                  ${canDelete ? `<button onclick="deleteStaff(${staff.id})" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>` : ""}
                              </div>`
                                  : ""
                              }
                          </td>
                      </tr>
                  `;
          })
          .join("");
      }

      // [Preserved Staff Form Modals Logic...]
      function openAddStaffModal(id = null) {
        editingStaffId = id;
        const modal = document.getElementById("add-staff-modal");
        const content = document.getElementById("add-staff-content");
        const title = document.getElementById("modal-title");
        const btn = document.getElementById("modal-submit-btn");

        const nameInput = document.getElementById("new-staff-name");
        const roleInput = document.getElementById("new-staff-role");
        const pinInput = document.getElementById("new-staff-pin");

        const roleContainer = document.getElementById(
          "new-staff-role-container",
        );

        if (id) {
          const staff = staffList.find((s) => s.id === id);
          title.innerText = t("modal_edit_staff");
          btn.innerText = t("modal_save");
          nameInput.value = staff.name;
          roleInput.value = staff.role;
          pinInput.value = staff.pin;

          if (staff.role === "Admin") {
            roleContainer.classList.add("hidden");
          } else {
            roleContainer.classList.remove("hidden");
          }
        } else {
          title.innerText = t("modal_add_staff");
          btn.innerText = t("modal_add_btn");
          nameInput.value = "";
          roleInput.value = "Waiter";
          pinInput.value = "1234";
          roleContainer.classList.remove("hidden");
        }

        modal.classList.remove("hidden");
        setTimeout(() => {
          content.classList.remove("scale-95", "opacity-0");
          content.classList.add("scale-100", "opacity-100");
        }, 10);
      }

      function closeAddStaffModal() {
        const modal = document.getElementById("add-staff-modal");
        const content = document.getElementById("add-staff-content");
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        setTimeout(() => {
          modal.classList.add("hidden");
          editingStaffId = null;
        }, 300);
      }

      function saveStaff() {
        const name = document.getElementById("new-staff-name").value;
        let role = document.getElementById("new-staff-role").value;
        const pin = document.getElementById("new-staff-pin").value;

        if (!name || !pin) return;

        if (editingStaffId) {
          const index = staffList.findIndex((s) => s.id === editingStaffId);
          if (index !== -1) {
            // Force role to remain Admin if they are already an Admin to prevent accidental lockout
            if (staffList[index].role === "Admin") {
              role = "Admin";
            }
            staffList[index].name = name;
            staffList[index].role = role;
            staffList[index].pin = pin;
            staffList[index].avatar = name.replace(" ", "+");
          }
          showToast(`${role} â€” ${t("toast_staff_updated")}`, "success");
        } else {
          const newStaff = {
            id: Date.now(),
            name: name,
            role: role,
            status: "Offline",
            pin: pin,
            avatar: name.replace(" ", "+"),
          };
          staffList.push(newStaff);
          showToast(`${role} â€” ${t("toast_staff_added")}`, "success");
        }
        renderStaffTable();
        saveData(); // <--- This saves the new staff member permanently!
        closeAddStaffModal();
      }
      function deleteStaff(id) {
        if (currentUser.role !== "Admin")
          return alert(t("alert_admin_only_delete"));

        const targetStaff = staffList.find((s) => s.id === id);
        if (targetStaff && targetStaff.role === "Admin") {
          return alert(
            t("alert_admin_cannot_delete_self") ||
              "Cannot delete Admin accounts.",
          );
        }

        if (confirm(t("confirm_remove_staff"))) {
          staffList = staffList.filter((s) => s.id !== id);
          renderStaffTable();
          saveData(); // <--- Saves the deletion!
        }
      }

      // --- PRODUCT MANAGEMENT ---
      function openAddProductModal(id = null) {
        editingProductId = id;
        const modal = document.getElementById("add-product-modal");
        const content = document.getElementById("add-product-content");
        const title = document.getElementById("product-modal-title");
        const btn = document.getElementById("product-modal-btn");

        const catSelect = document.getElementById("product-category");
        catSelect.innerHTML = categories
          .filter((c) => c.id !== "all")
          .map((c) => `<option value="${c.id}">${c.name}</option>`)
          .join("");

        const nameIn = document.getElementById("product-name");
        const priceIn = document.getElementById("product-price");
        const imgData = document.getElementById("product-image-data");
        const imgFile = document.getElementById("product-image-file");
        const imgPreview = document.getElementById("product-image-preview");
        const imgPlaceholder = document.getElementById(
          "product-image-placeholder",
        );

        if (id) {
          const prod = products.find((p) => p.id === id);
          title.innerText = "Edit Item";
          btn.innerText = "Update Item";
          nameIn.value = prod.name;
          priceIn.value = prod.price;
          catSelect.value = prod.category;
          imgData.value = prod.image;
          if (prod.image) {
            imgPreview.src = prod.image;
            imgPreview.classList.remove("hidden");
            imgPlaceholder.classList.add("hidden");
          } else {
            imgPreview.src = "";
            imgPreview.classList.add("hidden");
            imgPlaceholder.classList.remove("hidden");
          }
        } else {
          title.innerText = "Add New Item";
          btn.innerText = "Save Item";
          nameIn.value = "";
          priceIn.value = "";
          imgData.value = "";
          imgFile.value = "";
          imgPreview.src = "";
          imgPreview.classList.add("hidden");
          imgPlaceholder.classList.remove("hidden");
        }

        modal.classList.remove("hidden");
        setTimeout(() => {
          content.classList.remove("scale-95", "opacity-0");
          content.classList.add("scale-100", "opacity-100");
        }, 10);
      }

      function closeAddProductModal() {
        const modal = document.getElementById("add-product-modal");
        const content = document.getElementById("add-product-content");
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        setTimeout(() => {
          modal.classList.add("hidden");
          editingProductId = null;
        }, 300);
      }

      function previewProductImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const imgPreview = document.getElementById("product-image-preview");
            const imgPlaceholder = document.getElementById(
              "product-image-placeholder",
            );
            imgPreview.src = e.target.result;
            imgPreview.classList.remove("hidden");
            imgPlaceholder.classList.add("hidden");
            document.getElementById("product-image-data").value =
              e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      function saveProduct() {
        // Only Admin and Manager can add/edit items
        if (!currentUser || !["Admin", "Manager"].includes(currentUser.role)) {
          showToast(t("toast_admin_only"), "error");
          return;
        }

        const name = document.getElementById("product-name").value.trim();
        const price = parseFloat(
          document.getElementById("product-price").value,
        );
        const category = document.getElementById("product-category").value;
        const image =
          document.getElementById("product-image-data").value ||
          "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=400";

        if (!name) {
          showToast(t("toast_enter_name"), "error");
          return;
        }
        if (isNaN(price) || price <= 0) {
          showToast(t("toast_enter_price"), "error");
          return;
        }
        if (!category) {
          showToast(t("toast_select_category"), "error");
          return;
        }

        if (editingProductId) {
          const index = products.findIndex((p) => p.id === editingProductId);
          if (index !== -1) {
            products[index] = {
              ...products[index],
              name,
              price,
              category,
              image,
            };
          }
          showToast(t("toast_item_updated"), "success");
        } else {
          const newId =
            products.length > 0
              ? Math.max(...products.map((p) => p.id)) + 1
              : 1;
          products.push({ id: newId, name, price, category, image });
          showToast(t("toast_item_added"), "success");
        }

        saveData();
        renderCategories();
        renderMenu();
        closeAddProductModal();
      }

      function deleteProduct(id) {
        if (!currentUser || !["Admin", "Manager"].includes(currentUser.role)) {
          showToast(t("toast_admin_only"), "error");
          return;
        }
        if (confirm(t("confirm_delete_item"))) {
          products = products.filter((p) => p.id !== id);
          renderMenu();
          showToast(t("toast_item_deleted"), "success");
        }
      }

      // --- CATEGORY MANAGEMENT ---
      let editingCategoryId = null;

      function openCategoryModal(id = null) {
        if (!currentUser || currentUser.role !== "Admin") return;
        editingCategoryId = id;
        const modal = document.getElementById("add-category-modal");
        const content = document.getElementById("add-category-content");
        const title = document.getElementById("category-modal-title");
        const btn = document.getElementById("category-modal-btn");
        const nameIn = document.getElementById("category-name");
        const iconIn = document.getElementById("category-icon");
        const preview = document.getElementById("category-icon-preview");

        renderIconPicker();

        if (id) {
          const cat = categories.find((c) => c.id === id);
          title.innerText = "Edit Category";
          btn.querySelector("span").innerText = "Update Category";
          nameIn.value = cat.name;
          iconIn.value = cat.icon;
          preview.className = `fa-solid ${cat.icon}`;
        } else {
          title.innerText = "Add New Category";
          btn.querySelector("span").innerText = "Save Category";
          nameIn.value = "";
          iconIn.value = "fa-tag";
          preview.className = "fa-solid fa-tag";
        }

        modal.classList.remove("hidden");
        setTimeout(() => {
          content.classList.remove("scale-95", "opacity-0");
          content.classList.add("scale-100", "opacity-100");
        }, 10);
      }

      const RECOMMENDED_ICONS = [
        "fa-tag",
        "fa-pizza-slice",
        "fa-drumstick-bite",
        "fa-glass-water",
        "fa-coffee",
        "fa-bottle-water",
        "fa-wine-glass",
        "fa-ice-cream",
        "fa-cookie",
        "fa-cake-candles",
        "fa-fish",
        "fa-shrimp",
        "fa-carrot",
        "fa-apple-whole",
        "fa-seedling",
        "fa-bowl-rice",
        "fa-pepper-hot",
        "fa-bread-slice",
        "fa-croissant",
        "fa-burger",
        "fa-utensils",
        "fa-mug-hot",
        "fa-egg",
        "fa-cheese",
        "fa-bacon",
        "fa-hotdog",
        "fa-lemon",
        "fa-candy-cane",
      ];

      function renderIconPicker() {
        const grid = document.getElementById("icon-picker-grid");
        const iconIn = document.getElementById("category-icon");
        if (!grid) return;

        grid.innerHTML = RECOMMENDED_ICONS.map(
          (icon) => `
              <button onclick="selectPickerIcon('${icon}')"
                      class="w-10 h-10 flex items-center justify-center rounded-xl bg-white dark:bg-gray-700 text-gray-400 hover:bg-primary/10 hover:text-primary transition-all border border-transparent hover:border-primary/20">
                <i class="fa-solid ${icon}"></i>
              </button>
            `,
        ).join("");
      }

      function selectPickerIcon(icon) {
        const iconIn = document.getElementById("category-icon");
        const preview = document.getElementById("category-icon-preview");
        iconIn.value = icon;
        preview.className = `fa-solid ${icon}`;
      }

      function closeCategoryModal() {
        const modal = document.getElementById("add-category-modal");
        const content = document.getElementById("add-category-content");
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        setTimeout(() => {
          modal.classList.add("hidden");
          editingCategoryId = null;
        }, 200);
      }

      function saveCategory() {
        if (!currentUser || currentUser.role !== "Admin") return;
        const name = document.getElementById("category-name").value.trim();
        const icon =
          document.getElementById("category-icon").value.trim() || "fa-tag";

        if (!name) {
          showToast("Please enter category name", "error");
          return;
        }

        if (editingCategoryId) {
          const index = categories.findIndex((c) => c.id === editingCategoryId);
          if (index !== -1) {
            categories[index].name = name;
            categories[index].icon = icon;
          }
        } else {
          const id = name.toLowerCase().replace(/[^a-z0-9]/g, "-");
          // Prevent duplicate IDs
          if (categories.find((c) => c.id === id)) {
            showToast(
              "Category ID already exists (derived from name)",
              "error",
            );
            return;
          }
          categories.push({ id, name, icon, count: 0 });
        }

        localStorage.setItem("pos_categories", JSON.stringify(categories));
        renderCategories();
        closeCategoryModal();
        showToast("Category saved successfully", "success");
      }

      function deleteCategory(id) {
        if (!currentUser || currentUser.role !== "Admin") return;
        if (id === "all") return;

        const hasProducts = products.some((p) => p.category === id);
        if (hasProducts) {
          if (
            !confirm(
              "This category has items. Deleting it will leave items without a category. Proceed?",
            )
          )
            return;
        } else {
          if (!confirm("Are you sure you want to delete this category?"))
            return;
        }

        categories = categories.filter((c) => c.id !== id);
        localStorage.setItem("pos_categories", JSON.stringify(categories));

        if (activeCategory === id) activeCategory = "all";

        renderCategories();
        renderMenu();
        showToast("Category deleted", "success");
      }

      // --- WORKFLOW: TABLE LOGIC ---
      function canEditOrder(table) {
        return (
          table.status === STATUS.OCCUPIED ||
          ["Admin", "Manager"].includes(currentUser.role)
        );
      }

      function updateReleaseBtnVisibility(table) {
        const btn = document.getElementById("release-table-btn");
        const mobileBtn = document.getElementById("release-table-btn-mobile");

        const isAdmin = currentUser.role === "Admin";
        const canRelease =
          table &&
          (isAdmin || // Admin can always release
            (table.status === STATUS.OCCUPIED &&
              (table.lockedBy === currentUser.id ||
                currentUser.role === "Manager")));

        const updateBtn = (target) => {
          if (!target) return;
          if (canRelease) {
            target.classList.remove("hidden");
            target.classList.add("flex");
          } else {
            target.classList.add("hidden");
            target.classList.remove("flex");
          }
        };

        updateBtn(btn);
        updateBtn(mobileBtn);
      }

      function getStatusStyles(status) {
        switch (status) {
          case STATUS.AVAILABLE:
            return {
              cardBg: "bg-white dark:bg-gray-800",
              badgeBg: "bg-gray-100 dark:bg-gray-700",
              badgeText: "text-gray-500 dark:text-gray-400",
              glow: "",
              icon: "text-gray-200 dark:text-gray-700/50",
            };
          case STATUS.OCCUPIED:
            return {
              cardBg: "bg-gradient-to-br from-blue-500 to-cyan-500",
              badgeBg: "bg-white/20",
              badgeText: "text-white",
              glow: "shadow-[0_10px_30px_rgba(59,130,246,0.4)]",
              icon: "text-white/10",
            };
          case STATUS.SENT:
          case STATUS.PREPARING:
            return {
              cardBg: "bg-gradient-to-br from-purple-500 to-indigo-500",
              badgeBg: "bg-white/20",
              badgeText: "text-white",
              glow: "shadow-[0_10px_30px_rgba(168,85,247,0.4)]",
              icon: "text-white/10",
            };
          case STATUS.READY:
            return {
              cardBg: "bg-gradient-to-br from-green-500 to-emerald-500",
              badgeBg: "bg-white/20",
              badgeText: "text-white",
              glow: "shadow-[0_10px_30px_rgba(16,185,129,0.5)] ring-4 ring-green-500/30 ring-offset-2 dark:ring-offset-gray-900",
              icon: "text-white/10",
            };
          case STATUS.SERVED:
            return {
              cardBg: "bg-gradient-to-br from-orange-400 to-amber-500",
              badgeBg: "bg-white/20",
              badgeText: "text-white",
              glow: "shadow-[0_10px_30px_rgba(245,158,11,0.4)]",
              icon: "text-white/10",
            };
          default:
            return {
              cardBg: "bg-white dark:bg-gray-800",
              badgeBg: "bg-gray-100 dark:bg-gray-700",
              badgeText: "text-gray-500 dark:text-gray-400",
              glow: "",
              icon: "text-gray-200 dark:text-gray-700/50",
            };
        }
      }

      function renderTablesView() {
        const grid = document.getElementById("tables-grid");
        const addBtn = document.getElementById("add-table-btn");

        if (addBtn) {
          if (currentUser && ["Admin", "Manager"].includes(currentUser.role)) {
            addBtn.classList.remove("hidden");
          } else {
            addBtn.classList.add("hidden");
          }
        }

        if (!grid) return;

        grid.innerHTML = tables
          .map((table) => {
            const styles = getStatusStyles(table.status);
            const isAvailable = table.status === STATUS.AVAILABLE;
            const isLockedByOther =
              table.lockedBy &&
              table.lockedBy !== currentUser.id &&
              !["Admin", "Manager"].includes(currentUser.role);

            const total = table.cart.reduce(
              (sum, i) => sum + i.price * i.qty,
              0,
            );
            const itemCount = table.cart.reduce((sum, i) => sum + i.qty, 0);

            // Show a pulsing dot for statuses that require attention/action
            const needsPulse = [STATUS.OCCUPIED, STATUS.READY].includes(
              table.status,
            );

            const textColor = isAvailable
              ? "text-gray-800 dark:text-white"
              : "text-white";
            const subtextColor = isAvailable
              ? "text-gray-400 dark:text-gray-400"
              : "text-white/80";
            const borderColor = isAvailable
              ? "border-gray-200 dark:border-gray-700"
              : "border-white/20";
            const dashedBorder = isAvailable
              ? "border-gray-200 dark:border-gray-700"
              : "border-white/30";
            const pulseColor = isAvailable ? "bg-current" : "bg-white";

            const pulseHtml = needsPulse
              ? `<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full ${pulseColor} opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 ${pulseColor}"></span></span>`
              : "";

            return `
                      <div onclick="openTable('${table.id}')" class="${styles.cardBg} rounded-[2rem] p-6 border ${borderColor} cursor-pointer transition-all duration-300 group relative overflow-hidden ${styles.glow} hover:-translate-y-2 hover:shadow-2xl ${isLockedByOther ? "opacity-60 grayscale cursor-not-allowed hover:translate-y-0" : ""}">

                          <!-- Decorative Background Icon -->
                          <i class="fa-solid fa-utensils absolute -bottom-8 -right-8 text-9xl ${styles.icon} group-hover:scale-110 transition-transform duration-700 ease-out -rotate-12 z-0"></i>

                          ${!isAvailable ? '<div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent z-0"></div>' : ""}

                          <!-- Top Row: Table Number & Status -->
                          <div class="flex justify-between items-start mb-8 relative z-10">
                              <div class="w-16 h-16 rounded-2xl ${styles.badgeBg} flex items-center justify-center text-2xl font-black ${styles.badgeText} backdrop-blur-md shadow-sm border ${borderColor} group-hover:scale-110 transition-transform duration-300">
                                  ${table.id.replace("T", "")}
                              </div>
                              <div class="flex flex-col items-end gap-2">
                                  <span class="px-3 py-1.5 rounded-xl text-[10px] font-bold uppercase tracking-widest ${styles.badgeBg} ${styles.badgeText} backdrop-blur-md shadow-sm flex items-center gap-2 border ${borderColor}">
                                      ${pulseHtml}
                                      ${t("status_" + table.status.toLowerCase().replace(/\s+/g, "_").replace("sent_to_kitchen", "sent").replace("ready_to_serve", "ready").replace("waiting_payment", "payment")) || table.status}
                                  </span>
                                  ${isLockedByOther ? `<div class="bg-black/40 backdrop-blur-sm px-2.5 py-1 rounded-lg flex items-center gap-1.5 shadow-inner border border-white/10"><i class="fa-solid fa-lock text-white/70 text-xs"></i><span class="text-[10px] font-bold text-white">${table.waiterName?.split(" ")[0]}</span></div>` : ""}
                              </div>
                          </div>

                          <!-- Middle Row: Customer Info -->
                          <div class="mb-6 relative z-10">
                              <h3 class="font-bold text-2xl ${textColor} mb-1 group-hover:tracking-wide transition-all duration-300">${table.name === "Available" ? t("status_available") : table.name}</h3>
                              <p class="text-sm font-medium ${subtextColor} flex items-center gap-2">
                                  <i class="fa-solid fa-bell-concierge opacity-70"></i> ${itemCount} ${t("orders_items")}
                                  ${table.waiterName && !isLockedByOther ? `<span class="mx-1 opacity-50">â€¢</span><i class="fa-solid fa-user-tag opacity-70"></i> ${table.waiterName.split(" ")[0]}` : ""}
                              </p>
                          </div>

                          <!-- Bottom Row: Total -->
                          <div class="flex justify-between items-center pt-5 border-t border-dashed ${dashedBorder} relative z-10">
                              <span class="${subtextColor} text-xs font-bold uppercase tracking-wider" data-i18n="total">${t("total")}</span>
                              <span class="font-black text-3xl ${textColor}">$${total.toFixed(2)}</span>
                          </div>

                          <!-- Bottom animated accent bar -->
                          <div class="absolute bottom-0 left-0 w-full h-1.5 ${isAvailable ? "bg-primary" : "bg-white/40"} transform origin-left scale-x-0 group-hover:scale-x-100 transition-transform duration-500 ease-out z-20"></div>
                      </div>
                      `;
          })
          .join("");
      }

      function openTable(tableId) {
        const table = tables.find((t) => t.id === tableId);

        // Admin Reopen Check
        if (
          table.status === STATUS.AVAILABLE &&
          ["Admin", "Manager"].includes(currentUser.role)
        ) {
          // Use setTimeout to allow the openTable event to settle if they declined
          setTimeout(() => {
            if (table.status === STATUS.OCCUPIED && table.cart.length === 0) {
              promptReopenTable(tableId);
            }
          }, 50);
        }

        if (
          table.lockedBy &&
          table.lockedBy !== currentUser.id &&
          !["Admin", "Manager"].includes(currentUser.role)
        ) {
          showToast(
            t("toast_table_occupied").replace
              ? `${t("toast_table_occupied")} (${table.waiterName})`
              : t("toast_table_occupied"),
            "error",
          );
          return;
        }

        if (table.status === STATUS.AVAILABLE) {
          table.status = STATUS.OCCUPIED;
          table.lockedBy = currentUser.id;
          table.waiterName = currentUser.name;
          table.name = currentUser.name;
          table.openedAt = new Date();
          table.timestamps = { opened: new Date() };
          table.bg = "bg-green-100";
          table.text = "text-green-600";
        }

        activeTableId = tableId;
        document.getElementById("cart-table-name").innerText =
          `Table ${table.id.replace("T", "")}`;
        document.getElementById("cart-customer-name").innerText = table.name;
        updateReleaseBtnVisibility(table);

        saveData();
        switchView("pos");
      }

      function addNewTable() {
        // Open the custom modal instead of native prompt()
        const modal = document.getElementById("add-table-modal");
        const content = document.getElementById("add-table-content");
        const input = document.getElementById("add-table-count");
        if (!modal) return;
        input.value = "1";
        modal.classList.remove("hidden");
        requestAnimationFrame(() => {
          content.classList.remove("scale-95", "opacity-0");
          content.classList.add("scale-100", "opacity-100");
          input.focus();
          input.select();
        });
      }

      function closeAddTableModal() {
        const modal = document.getElementById("add-table-modal");
        const content = document.getElementById("add-table-content");
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        setTimeout(() => modal.classList.add("hidden"), 250);
      }

      function confirmAddTable() {
        const countStr = document.getElementById("add-table-count").value;
        const count = parseInt(countStr);
        if (isNaN(count) || count <= 0) {
          showToast(
            t("toast_invalid_number") || "Please enter a valid number.",
            "error",
          );
          return;
        }

        closeAddTableModal();

        // Add 'count' number of tables
        let nextId =
          tables.length > 0
            ? Math.max(
                ...tables.map((t) => parseInt(t.id.replace("T", "")) || 0),
              ) + 1
            : 1;

        for (let i = 0; i < count; i++) {
          const newTable = {
            id: `T${nextId}`,
            name: "Available",
            status: "Available",
            bg: "bg-gray-100",
            text: "text-gray-400",
            cart: [],
            lockedBy: null,
            waiterName: null,
            openedAt: null,
            timestamps: {},
            recallTimer: null,
            recallRemaining: 0,
            payRecords: [],
          };

          tables.push(newTable);

          // Tell the Mac server a completely new table was created!
          if (typeof socket !== "undefined") {
            socket.emit("update_table", newTable);
          }

          nextId++;
        }
        saveData();
        renderTablesView();
        showToast(`${t("table_added")} (${count})`, "success");
      }

      // --- ORDERS LOGIC ---
      function renderOrderHistory() {
        const tbody = document.getElementById("orders-table-body");
        if (!tbody) return;

        let displayOrders = orderHistory;
        if (currentUser && currentUser.role === "Waiter") {
          displayOrders = orderHistory.filter(
            (o) =>
              o.waiterId === currentUser.id || o.waiter === currentUser.name,
          );
        }

        if (displayOrders.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No completed orders yet today.</td></tr>`;
          return;
        }

        // Sort newest first
        const sorted = [...displayOrders].sort(
          (a, b) => new Date(b.timestamps.paid) - new Date(a.timestamps.paid),
        );

        tbody.innerHTML = sorted
          .map((order) => {
            // Create a summary of items (e.g. "2x Burger, 1x Coke ...")
            const itemNames = order.items
              .map(
                (i) =>
                  `<span class="font-medium text-gray-700 dark:text-gray-200">${i.qty}x</span> ${i.name}`,
              )
              .join(
                '<span class="mx-1 text-gray-300 dark:text-gray-600">â€¢</span>',
              );

            // Count total unique items
            const totalItems = order.items.reduce((sum, i) => sum + i.qty, 0);

            const datePaid = new Date(order.timestamps.paid).toLocaleDateString(
              [],
              { month: "short", day: "numeric" },
            );
            const timePaid = formatTime(new Date(order.timestamps.paid));

            return `
                <tr class="group bg-white dark:bg-gray-800 hover:shadow-md hover:-translate-y-0.5 transition-all duration-300 rounded-2xl">
                  <!-- Order ID & Status -->
                  <td class="px-6 py-4 rounded-l-2xl border-y border-l border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 shrink-0">
                        <i class="fa-solid fa-receipt"></i>
                      </div>
                      <div>
                        <div class="font-bold text-gray-900 dark:text-white text-base">#${order.orderId}</div>
                        <div class="flex items-center gap-1.5 mt-1 flex-wrap">
                          <div class="text-xs font-semibold text-green-500 bg-green-50 dark:bg-green-500/10 px-2 py-0.5 rounded-full inline-block">Paid</div>
                          ${(() => {
                            const method =
                              order.payments && order.payments[0]
                                ? order.payments[0].method
                                : "Cash";
                            const colors = {
                              Cash: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
                              Zaad: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",
                              "E-dahab":
                                "bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400",
                            };
                            const icons = {
                              Cash: "fa-money-bill",
                              Zaad: "fa-mobile-screen-button",
                              "E-dahab": "fa-mobile-screen-button",
                            };
                            const colorClass =
                              colors[method] || "bg-gray-100 text-gray-600";
                            const iconClass = icons[method] || "fa-credit-card";
                            const canEdit = [
                              "Admin",
                              "Manager",
                              "Cashier",
                            ].includes(currentUser.role);
                            if (canEdit) {
                              return `<div class="relative inline-block">
                                <select onchange="changePaymentMethod(${order.orderId}, this.value)" title="Change payment method"
                                  class="text-xs font-bold px-2 py-0.5 rounded-full border-0 outline-none cursor-pointer ${colorClass} appearance-none pr-5">
                                  <option value="Cash" ${method === "Cash" ? "selected" : ""}>ðŸ’µ Cash</option>
                                  <option value="Zaad" ${method === "Zaad" ? "selected" : ""}>ðŸ“± Zaad</option>
                                  <option value="E-dahab" ${method === "E-dahab" ? "selected" : ""}>ðŸ§¾ E-dahab</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-1 top-1/2 -translate-y-1/2 text-[8px] pointer-events-none"></i>
                              </div>`;
                            } else {
                              return `<span class="text-xs font-bold px-2 py-0.5 rounded-full inline-flex items-center gap-1 ${colorClass}"><i class="fa-solid ${iconClass} text-[9px]"></i>${method}</span>`;
                            }
                          })()}
                        </div>
                      </div>
                    </div>
                  </td>

                  <!-- Table & Waiter -->
                  <td class="px-6 py-4 border-y border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/40 flex items-center justify-center text-orange-600 dark:text-orange-400 font-bold shrink-0 text-xs">
                        ${order.tableId.replace("T", "")}
                      </div>
                      <div>
                        <div class="font-bold text-gray-800 dark:text-gray-200">${order.tableId}</div>
                        <div class="text-xs text-gray-400 flex items-center gap-1"><i class="fa-solid fa-user-tag text-[10px]"></i> ${order.waiter}</div>
                      </div>
                    </div>
                  </td>

                  <!-- Items -->
                  <td class="px-6 py-4 border-y border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700">
                    <div class="flex flex-col justify-center">
                      <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">${totalItems} Items</span>
                      <div class="text-sm text-gray-500 dark:text-gray-400 max-w-sm truncate" title="${order.items.map((i) => `${i.qty}x ${i.name}`).join(", ")}">
                        ${itemNames}
                      </div>
                    </div>
                  </td>

                  <!-- Price -->
                  <td class="px-6 py-4 border-y border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700 text-right">
                    <span class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-gray-50 dark:bg-gray-900 font-black text-lg text-gray-900 dark:text-white border border-gray-100 dark:border-gray-700">
                      $${order.total.toFixed(2)}
                    </span>
                  </td>

                  <!-- Timestamp -->
                  <td class="px-6 py-4 border-y border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700 text-right">
                    <div class="flex flex-col items-end justify-center">
                      <span class="font-bold text-gray-700 dark:text-gray-300">${timePaid}</span>
                      <span class="text-xs text-gray-400">${datePaid}</span>
                    </div>
                  </td>

                  <!-- Print Button (Admin/Manager/Cashier only) -->
                  <td class="px-6 py-4 rounded-r-2xl border-y border-r border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700 text-right">
                    ${
                      ["Admin", "Manager", "Cashier"].includes(currentUser.role)
                        ? `
                      <button onclick="printOrderReceipt(${order.orderId})" title="Print Receipt"
                        class="w-9 h-9 rounded-xl bg-primary/10 text-primary hover:bg-primary hover:text-white transition-all duration-200 flex items-center justify-center ml-auto active:scale-90 shadow-sm">
                        <i class="fa-solid fa-print text-sm"></i>
                      </button>
                    `
                        : ""
                    }
                  </td>
                </tr>
              `;
          })
          .join("");
      }

      function changePaymentMethod(orderId, newMethod) {
        const order = orderHistory.find((o) => o.orderId === orderId);
        if (!order) return;
        if (!["Admin", "Manager", "Cashier"].includes(currentUser.role)) return;

        if (order.payments && order.payments.length > 0) {
          order.payments[0].method = newMethod;
        } else {
          order.payments = [
            {
              method: newMethod,
              amount: order.total,
              timestamp: new Date().toISOString(),
              user: currentUser.name,
            },
          ];
        }
        saveData();
        renderOrderHistory();
        showToast(`Payment updated to ${newMethod}`, "success");
      }

      function printOrderReceipt(orderId) {
        const order = orderHistory.find((o) => o.orderId === orderId);
        if (!order) return;

        const paidAt = new Date(order.timestamps.paid);

        document.getElementById("receipt-date").innerText =
          paidAt.toLocaleDateString([], {
            weekday: "short",
            month: "short",
            day: "numeric",
            year: "numeric",
          });
        document.getElementById("receipt-time").innerText = formatTime(paidAt);
        document.getElementById("receipt-order-id").innerText =
          "#" + order.orderId;
        document.getElementById("receipt-table").innerText = order.tableId;
        document.getElementById("receipt-waiter").innerText = order.waiter;

        const subtotal = order.total / 1.05;
        const tax = order.total - subtotal;
        document.getElementById("receipt-subtotal").innerText =
          "$" + subtotal.toFixed(2);
        document.getElementById("receipt-tax").innerText = "$" + tax.toFixed(2);
        document.getElementById("receipt-total").innerText =
          "$" + order.total.toFixed(2);

        document.getElementById("receipt-items").innerHTML = order.items
          .map(
            (i) => `
              <tr>
                <td class="py-1">${i.name}</td>
                <td class="py-1 text-center">${i.qty}</td>
                <td class="py-1 text-right">$${(i.price * i.qty).toFixed(2)}</td>
              </tr>
            `,
          )
          .join("");

        // Swap footer buttons: Close + Reprint (no Pay button)
        const actionsDiv = document.querySelector(
          "#receipt-modal .bg-gray-100 .flex",
        );
        if (actionsDiv) {
          actionsDiv.innerHTML = `
                <button onclick="closeReceiptModal()" class="flex-1 py-3 text-gray-600 font-bold bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">Close</button>
                <button onclick="window.print()" class="flex-1 py-3 text-white font-bold bg-primary hover:bg-primary-dark rounded-xl shadow-lg transition-colors flex items-center justify-center gap-2">
                  <i class="fa-solid fa-print"></i> Print Receipt
                </button>
              `;
        }

        document.getElementById("receipt-modal").classList.remove("hidden");
      }

      // --- ADMIN TOOLS ---
      function showDailySales() {
        if (!currentUser || !["Admin", "Manager"].includes(currentUser.role))
          return;
        const today = new Date().toDateString();
        const todaysOrders = orderHistory.filter(
          (o) => new Date(o.timestamps.paid).toDateString() === today,
        );

        const total = todaysOrders.reduce((sum, o) => sum + o.total, 0);
        const tips = todaysOrders.reduce((sum, o) => {
          const paid = o.payments
            ? o.payments.reduce((s, p) => s + p.amount, 0)
            : 0;
          return sum + Math.max(0, paid - o.total);
        }, 0);

        console.log(`=== DAILY SALES SUMMARY (${today}) ===`);
        console.log(`Total Orders Completed: ${todaysOrders.length}`);
        console.log(`Gross Revenue: $${total.toFixed(2)}`);
        console.log(`Total Tips/Overpayment: $${tips.toFixed(2)}`);
        console.log("Details:", todaysOrders);

        alert(
          `=== DAILY SALES (${today}) ===\nOrders: ${todaysOrders.length}\nRevenue: $${total.toFixed(2)}\nCheck console for details.`,
        );
      }

      // Attach to logo secretly
      document.addEventListener("DOMContentLoaded", () => {
        const logo = document.querySelector(".fa-fire-burner")?.parentElement;
        if (logo) {
          logo.addEventListener("dblclick", showDailySales);
          logo.style.cursor = "pointer";
        }
      });

      // --- POS LOGIC ---
      function renderCategories() {
        const container = document.getElementById("category-container");
        if (!container) return;

        const isAdmin = currentUser && currentUser.role === "Admin";

        let html = categories
          .map((cat) => {
            const count =
              cat.id === "all"
                ? products.length
                : products.filter((p) => p.category === cat.id).length;
            return `
                      <div onclick="setCategory('${cat.id}')"
                           class="cursor-pointer min-w-[100px] md:min-w-[140px] p-2.5 md:p-4 rounded-3xl border transition-all flex flex-col items-start gap-2.5 md:gap-4 relative group ${activeCategory === cat.id ? "bg-primary/10 border-primary shadow-sm" : "bg-white dark:bg-gray-800 border-transparent hover:border-gray-200 dark:hover:border-gray-600"}">

                          ${
                            isAdmin && cat.id !== "all"
                              ? `
                          <div class="absolute top-2 right-2 flex gap-1 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                              <button onclick="event.stopPropagation(); openCategoryModal('${cat.id}')" class="w-6 h-6 rounded-full bg-white text-blue-500 shadow-md hover:bg-blue-50 flex items-center justify-center text-[10px]"><i class="fa-solid fa-pen"></i></button>
                              <button onclick="event.stopPropagation(); deleteCategory('${cat.id}')" class="w-6 h-6 rounded-full bg-white text-red-500 shadow-md hover:bg-red-50 flex items-center justify-center text-[10px]"><i class="fa-solid fa-trash"></i></button>
                          </div>
                          `
                              : ""
                          }

                          <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-sm md:text-lg ${activeCategory === cat.id ? "bg-primary text-white" : "bg-gray-50 dark:bg-gray-700 text-gray-400"}">
                              <i class="fa-solid ${cat.icon}"></i>
                          </div>
                          <div>
                              <h3 class="font-bold text-xs md:text-base text-gray-800 dark:text-white ${activeCategory === cat.id ? "text-primary-dark" : ""}">${cat.name}</h3>
                              <p class="text-[10px] text-gray-400 dark:text-gray-300">${count} items</p>
                          </div>
                      </div>
                  `;
          })
          .join("");

        if (isAdmin) {
          html += `
                      <div onclick="openCategoryModal()"
                           class="cursor-pointer min-w-[120px] md:min-w-[140px] p-3 md:p-4 rounded-3xl border-2 border-dashed border-gray-200 dark:border-gray-600 hover:border-primary transition-all flex flex-col items-center justify-center gap-2 group">
                          <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-50 dark:bg-gray-700 text-gray-400 group-hover:bg-primary group-hover:text-white flex items-center justify-center transition-colors">
                              <i class="fa-solid fa-plus"></i>
                          </div>
                          <span class="text-xs font-bold text-gray-400 group-hover:text-primary transition-colors">Add Category</span>
                      </div>
                  `;
        }

        container.innerHTML = html;
      }

      function setCategory(id) {
        activeCategory = id;
        renderCategories();
        renderMenu();
      }

      function renderMenu() {
        const container = document.getElementById("menu-container");
        if (!container) return;

        const searchTerm =
          document.getElementById("search-input")?.value.toLowerCase() || "";

        const filtered = products.filter((p) => {
          const matchesCategory =
            activeCategory === "all" || p.category === activeCategory;
          const matchesSearch = p.name.toLowerCase().includes(searchTerm);
          return matchesCategory && matchesSearch;
        });

        const activeTable = tables.find((t) => t.id === activeTableId);
        const isAdmin = currentUser && currentUser.role === "Admin";
        const canModify = activeTable && canEditOrder(activeTable);

        container.innerHTML = filtered
          .map((item) => {
            const inCart =
              activeTable && activeTable.cart.find((c) => c.id === item.id);
            const qty = inCart ? inCart.qty : 0;

            return `
                      <div class="bg-white dark:bg-gray-800 p-3 md:p-4 rounded-[1.5rem] md:rounded-[2rem] shadow-sm hover:shadow-md transition-all border ${inCart ? "border-primary" : "border-transparent"} flex flex-col items-center text-center relative overflow-hidden group">

                          ${
                            isAdmin
                              ? `
                          <div class="absolute top-4 left-4 flex gap-1 z-10 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                              <button onclick="event.stopPropagation(); openAddProductModal(${item.id})" class="w-7 h-7 rounded-full bg-white text-blue-500 shadow-md hover:bg-blue-50 flex items-center justify-center text-xs"><i class="fa-solid fa-pen"></i></button>
                              <button onclick="event.stopPropagation(); deleteProduct(${item.id})" class="w-7 h-7 rounded-full bg-white text-red-500 shadow-md hover:bg-red-50 flex items-center justify-center text-xs"><i class="fa-solid fa-trash"></i></button>
                          </div>
                          `
                              : ""
                          }

                          <div class="w-24 h-24 md:w-32 md:h-32 rounded-full overflow-hidden mb-3 md:mb-4 shadow-lg group-hover:scale-105 transition-transform duration-500">
                              <img src="${item.image}" class="w-full h-full object-cover">
                          </div>
                          <h3 class="font-bold text-gray-800 dark:text-white text-xs md:text-sm leading-tight mb-1 md:mb-2 h-8 md:h-10 overflow-hidden px-1">${item.name}</h3>
                          <div class="text-primary font-bold mb-3 md:mb-4 text-sm md:text-base">$${item.price.toFixed(2)}</div>
                          ${
                            qty > 0
                              ? `
                              <div class="flex items-center gap-2 md:gap-4 bg-gray-100 dark:bg-gray-700 rounded-xl px-2 py-1 w-full justify-between">
                                  <button onclick="updateQty(${item.id}, -1)" class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-white dark:bg-gray-600 text-gray-600 dark:text-white shadow-sm hover:text-red-500 flex items-center justify-center font-bold text-sm ${!canModify ? "opacity-50 cursor-not-allowed" : ""}">-</button>
                                  <span class="font-bold text-gray-800 dark:text-white w-4 text-sm md:text-base">${qty}</span>
                                  <button onclick="updateQty(${item.id}, 1)" class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-primary text-white shadow-sm hover:bg-primary-dark flex items-center justify-center font-bold text-sm ${!canModify ? "opacity-50 cursor-not-allowed" : ""}">+</button>
                              </div>
                          `
                              : `
                              <button onclick="addToCart(${item.id})" class="w-full py-2 md:py-3 bg-primary/10 text-primary font-bold rounded-xl hover:bg-primary hover:text-white transition-all text-xs md:text-sm ${!canModify ? "opacity-50 cursor-not-allowed" : ""}">Add to Dish</button>
                          `
                          }
                      </div>
                  `;
          })
          .join("");
      }

      function addToCart(id) {
        const activeTable = tables.find((t) => t.id === activeTableId);
        if (!activeTable) return;

        if (!canEditOrder(activeTable)) {
          showToast(t("toast_cannot_modify_sent"), "warning");
          return;
        }

        const existing = activeTable.cart.find((c) => c.id === id);
        if (existing) {
          existing.qty += 1;
        } else {
          const item = products.find((p) => p.id === id);
          activeTable.cart.push({ ...item, qty: 1 });
        }
        renderMenu();
        renderCart();
        updateMobileCartButton();
        saveData();
      }

      function updateQty(id, delta) {
        const activeTable = tables.find((t) => t.id === activeTableId);
        if (!canEditOrder(activeTable)) {
          showToast(t("toast_cannot_modify_sent"), "warning");
          return;
        }

        const idx = activeTable.cart.findIndex((c) => c.id === id);
        if (idx > -1) {
          activeTable.cart[idx].qty += delta;
          if (activeTable.cart[idx].qty <= 0) activeTable.cart.splice(idx, 1);
        }
        renderMenu();
        renderCart();
        updateMobileCartButton();
        saveData();
      }

      function renderCart() {
        const container = document.getElementById("cart-container");
        const emptyMsg =
          '<div id="empty-cart-msg" class="h-full flex flex-col items-center justify-center text-gray-300 dark:text-gray-500"><i class="fa-solid fa-utensils text-5xl mb-4 opacity-50"></i><p class="font-medium">No items yet</p></div>';
        const activeTable = tables.find((t) => t.id === activeTableId);

        const statusBadge = document.getElementById("cart-status-badge");
        if (statusBadge && activeTable) {
          statusBadge.innerText = activeTable.status;
          // Use solid colors for the badge in the white cart sidebar (not transparent overlays)
          const badgeStyles = {
            [STATUS.AVAILABLE]: "bg-gray-100 text-gray-500",
            [STATUS.OCCUPIED]: "bg-blue-100 text-blue-600",
            [STATUS.SENT]: "bg-purple-100 text-purple-700",
            [STATUS.PREPARING]: "bg-purple-100 text-purple-700",
            [STATUS.READY]: "bg-green-100 text-green-700",
            [STATUS.SERVED]: "bg-orange-100 text-orange-600",
          };
          const colorClass =
            badgeStyles[activeTable.status] || "bg-gray-100 text-gray-500";
          statusBadge.className = `mt-2 inline-block px-3 py-1.5 rounded-xl text-[10px] font-bold uppercase tracking-widest ${colorClass} shadow-sm`;
        }

        // --- Reset button visibility (runs before early return so it always applies) ---
        updateReleaseBtnVisibility(activeTable);

        if (!activeTable || activeTable.cart.length === 0) {
          container.innerHTML = emptyMsg;
          updateTotals();
          updateMobileCartButton();
          updateMainActionButton();
          return;
        }

        const canModify = canEditOrder(activeTable);

        container.innerHTML = activeTable.cart
          .map(
            (item) => `
                      <div class="flex items-center gap-3 animate-fade-in border-b border-gray-50 dark:border-gray-700 pb-2 last:border-0">
                          <img src="${item.image}" class="w-14 h-14 md:w-16 md:h-16 rounded-2xl object-cover bg-gray-100">
                          <div class="flex-1 min-w-0">
                              <h4 class="text-xs md:text-sm font-bold text-gray-800 dark:text-white truncate mb-1">${item.name}</h4>
                              <div class="flex items-center justify-between">
                                  <span class="text-primary font-bold text-sm">$${item.price}</span>
                                  <div class="flex items-center gap-2">
                                      ${canModify ? `<button onclick="updateQty(${item.id}, -1)" class="w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-xs"><i class="fa-solid fa-minus"></i></button>` : ""}
                                      <span class="text-gray-400 dark:text-gray-300 text-xs font-bold">${item.qty} ${!canModify ? "X" : ""}</span>
                                      ${canModify ? `<button onclick="updateQty(${item.id}, 1)" class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-xs"><i class="fa-solid fa-plus"></i></button>` : ""}
                                  </div>
                              </div>
                          </div>
                      </div>
                  `,
          )
          .join("");

        updateTotals();
        updateMobileCartButton();
        updateMainActionButton();
      }

      function updateTotals() {
        const activeTable = tables.find((t) => t.id === activeTableId);
        const sub = activeTable
          ? activeTable.cart.reduce((sum, i) => sum + i.price * i.qty, 0)
          : 0;
        const tax = sub * 0.05;
        document.getElementById("subtotal-display").innerText =
          `$${sub.toFixed(2)}`;
        document.getElementById("tax-display").innerText = `$${tax.toFixed(2)}`;
        document.getElementById("total-display").innerText =
          `$${(sub + tax).toFixed(2)}`;
        if (document.getElementById("total-display-mobile")) {
          document.getElementById("total-display-mobile").innerText =
            `$${(sub + tax).toFixed(2)}`;
        }
      }

      function setPaymentMethod(method) {
        selectedPayment = method;
        document.querySelectorAll(".payment-btn").forEach((btn) => {
          btn.className =
            "payment-btn flex-1 py-3 px-2 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-400 hover:border-gray-300 flex flex-col items-center justify-center gap-1 transition-all";
        });
        const activeBtn = document.getElementById(
          `pay-${method.toLowerCase()}`,
        );
        if (activeBtn)
          activeBtn.className =
            "payment-btn flex-1 py-3 px-2 rounded-xl border border-primary bg-primary/5 text-primary flex flex-col items-center justify-center gap-1 transition-all";
      }

      // --- TABLE RELEASE LOGIC ---
      function requestReleaseTable() {
        const activeTable = tables.find((t) => t.id === activeTableId);
        if (!activeTable) return;

        const isAdmin = currentUser.role === "Admin";

        // Frontend guard: status check (Admin bypasses this)
        if (!isAdmin && activeTable.status !== STATUS.OCCUPIED) {
          showToast(t("toast_cannot_release_kitchen"), "error");
          return;
        }

        // Frontend guard: permission check
        const isAuthorized =
          isAdmin ||
          activeTable.lockedBy === currentUser.id ||
          currentUser.role === "Manager";
        if (!isAuthorized) {
          showToast(t("toast_no_permission_release"), "error");
          return;
        }

        openReleaseModal();
      }

      function openReleaseModal() {
        const modal = document.getElementById("release-table-modal");
        const content = document.getElementById("release-modal-content");
        if (!modal || !content) return;
        modal.classList.remove("hidden");
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            content.style.transform = "scale(1)";
            content.style.opacity = "1";
          });
        });
      }

      function closeReleaseModal() {
        const modal = document.getElementById("release-table-modal");
        const content = document.getElementById("release-modal-content");
        if (!modal || !content) return;
        content.style.transform = "scale(0.93)";
        content.style.opacity = "0";
        setTimeout(() => modal.classList.add("hidden"), 200);
      }

      function confirmReleaseTable() {
        const activeTable = tables.find((t) => t.id === activeTableId);
        if (!activeTable) {
          closeReleaseModal();
          return;
        }

        const isAdmin = currentUser.role === "Admin";

        // Backend-equivalent validation (re-validated server-side in memory)
        if (!isAdmin && activeTable.status !== STATUS.OCCUPIED) {
          closeReleaseModal();
          showToast(t("toast_cannot_release_kitchen"), "error");
          return;
        }
        const isAuthorized =
          isAdmin ||
          activeTable.lockedBy === currentUser.id ||
          currentUser.role === "Manager";
        if (!isAuthorized) {
          closeReleaseModal();
          showToast(t("toast_no_permission_release"), "error");
          return;
        }

        const assignedUserId = activeTable.lockedBy;

        // Perform the release
        activeTable.cart = [];
        activeTable.status = STATUS.AVAILABLE;
        activeTable.lockedBy = null;
        activeTable.waiterName = null;
        activeTable.name = "Available";
        activeTable.bg = "bg-gray-100";
        activeTable.text = "text-gray-400";
        activeTable.openedAt = null;
        activeTable.timestamps = {};
        activeTable.payRecords = [];

        activeTableId = null;
        renderCart();

        saveData();
        closeReleaseModal();

        if (!currentUser || currentUser.id === assignedUserId) {
          handleTableReleaseRedirect();
        } else {
          setTimeout(() => {
            renderTablesView();
            switchView("tables");
            showToast(t("toast_table_released"), "success");
          }, 220);
        }
      }

      // --- WORKFLOW BUTTON LOGIC ---
      function updateMainActionButton() {
        const activeTable = tables.find((t) => t.id === activeTableId);
        const btn = document.getElementById("main-action-btn");
        const pmc = document.getElementById("payment-methods-container");

        if (!activeTable || activeTable.cart.length === 0) {
          btn.innerText = t("send_to_kitchen");
          btn.className =
            "w-full bg-gray-300 dark:bg-gray-700 text-gray-500 font-bold py-4 rounded-xl transition-all cursor-not-allowed text-sm uppercase tracking-wide";
          btn.disabled = true;
          pmc.classList.add("hidden");
          return;
        }

        btn.disabled = false;
        btn.className =
          "w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30 transition-all active:scale-95 text-sm uppercase tracking-wide";

        pmc.classList.add("hidden");

        // Manage Recall Button injection (Removed, handled by main button)
        let recallBtn = document.getElementById("recall-order-btn");
        if (recallBtn) recallBtn.remove();

        switch (activeTable.status) {
          case STATUS.OCCUPIED:
            btn.innerText = t("send_to_kitchen");
            break;
          case STATUS.SENT:
            if (activeTable.recallRemaining > 0) {
              btn.innerText = `${t("recall_order")} (${activeTable.recallRemaining}s)`;
              btn.className =
                "w-full bg-red-50 text-red-500 hover:bg-red-100 font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide border border-red-200";
            } else {
              btn.innerText = t("waiting_chef");
              btn.className =
                "w-full bg-yellow-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide cursor-wait";
            }
            break;
          case STATUS.PREPARING:
            btn.innerText = t("kitchen_preparing") + "...";
            btn.className =
              "w-full bg-yellow-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide cursor-wait";
            break;
          case STATUS.READY:
            btn.innerText = t("ready_to_serve");
            btn.className =
              "w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide";
            break;
          case STATUS.SERVED:
            btn.innerText = t("pay_print");
            btn.className =
              "w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide";
            pmc.classList.remove("hidden");
            break;
          default:
            btn.innerText = t("send_to_kitchen");
        }
      }

      // --- MAIN ACTION LOGIC ---
      function handleMainAction() {
        const activeTable = tables.find((t) => t.id === activeTableId);
        if (!activeTable || activeTable.cart.length === 0) return;

        switch (activeTable.status) {
          case STATUS.OCCUPIED:
            const orderId = currentOrderId++;
            const newOrder = {
              id: orderId,
              tableId: activeTable.id,
              waiterId: activeTable.lockedBy,
              waiterName: activeTable.waiterName,
              time: formatTime(new Date()),
              items: JSON.parse(JSON.stringify(activeTable.cart)),
              status: "new",
            };
            kitchenOrders.unshift(newOrder);
            socket.emit("send_to_kitchen", newOrder); // Send to Mac's Kitchen!
            activeTable.status = STATUS.SENT;
            activeTable.timestamps.sent = new Date();

            // Start 30-Second Recall Timer
            activeTable.recallRemaining = 30;
            if (activeTable.recallTimer) clearInterval(activeTable.recallTimer);

            activeTable.recallTimer = setInterval(() => {
              const t = tables.find((tbl) => tbl.id === activeTable.id);
              if (!t || t.status !== STATUS.SENT || t.recallRemaining <= 0) {
                if (t && t.recallTimer) {
                  clearInterval(t.recallTimer);
                  t.recallTimer = null;
                }
                updateMainActionButton();
                return;
              }
              t.recallRemaining--;
              if (t.id === activeTableId) updateMainActionButton();
            }, 1000);

            saveData();
            renderKitchen();
            updateMainActionButton(); // immediate visual change

            showToast(
              `${t("nav_orders")} #${orderId} â€” ${t("toast_sent_kitchen")}`,
              "success",
            );
            break;

          case STATUS.SENT:
            // If clicked while SENT and there's time remaining, Recall it!
            if (activeTable.recallRemaining > 0) {
              kitchenOrders = kitchenOrders.filter(
                (o) => o.tableId !== activeTable.id || o.status !== "new",
              );
              activeTable.status = STATUS.OCCUPIED;
              if (activeTable.recallTimer)
                clearInterval(activeTable.recallTimer);
              activeTable.recallTimer = null;
              activeTable.recallRemaining = 0;
              showToast(t("toast_recalled"), "success");
              saveData();
            } else {
              showToast(t("toast_kitchen_waiting"), "info");
            }
            break;

          case STATUS.READY:
            activeTable.status = STATUS.SERVED;
            activeTable.timestamps.served = new Date();
            showToast(t("toast_order_served"), "success");
            saveData();
            break;

          case STATUS.SERVED:
            const sub = activeTable.cart.reduce(
              (sum, i) => sum + i.price * i.qty,
              0,
            );
            const tax = sub * 0.05;
            const totalAmount = sub + tax; // Include tax

            const alreadyPaid = activeTable.payRecords.reduce(
              (sum, record) => sum + record.amount,
              0,
            );
            const remaining = totalAmount - alreadyPaid;

            if (remaining <= 0) {
              showToast(t("toast_order_fully_paid"), "info");
              releaseTableAndLog(activeTable, totalAmount);
              return;
            }

            openReceiptModal(activeTable, remaining, totalAmount, sub, tax);
            break;
        }

        renderMenu();
        renderCart();

        const cartPanel = document.getElementById("pos-cart-panel");
        if (
          cartPanel &&
          cartPanel.classList.contains("cart-mobile-visible") &&
          activeTable.status !== STATUS.WAITING_PAYMENT
        ) {
          toggleMobileCart();
        }
      }

      // --- RECEIPT MODAL LOGIC ---
      let currentReceiptTable = null;
      let currentReceiptTotal = 0;

      function openReceiptModal(
        table,
        remainingAmount,
        totalAmount,
        subtotal,
        taxAmount,
      ) {
        currentReceiptTable = table;
        currentReceiptTotal = totalAmount; // The amount we are trying to resolve

        const now = new Date();
        document.getElementById("receipt-date").innerText =
          now.toLocaleDateString();
        document.getElementById("receipt-time").innerText = formatTime(now);

        document.getElementById("receipt-order-id").innerText =
          `#${table.cart.length > 0 ? table.cart[0].id : Date.now().toString().slice(-4)}`;
        document.getElementById("receipt-table").innerText = table.id;
        document.getElementById("receipt-waiter").innerText = table.waiterName;

        document.getElementById("receipt-subtotal").innerText =
          `$${subtotal.toFixed(2)}`;
        document.getElementById("receipt-tax").innerText =
          `$${taxAmount.toFixed(2)}`;

        // Handle partial payment display if needed
        const alreadyPaid = table.payRecords.reduce(
          (sum, record) => sum + record.amount,
          0,
        );
        let totalDisplayHTML = `$${totalAmount.toFixed(2)}`;
        if (alreadyPaid > 0) {
          totalDisplayHTML += `<br><span class="text-xs text-gray-500 font-normal">Paid: $${alreadyPaid.toFixed(2)}</span><br><span class="text-sm">Remaining: $${remainingAmount.toFixed(2)}</span>`;
        }
        document.getElementById("receipt-total").innerHTML = totalDisplayHTML;

        const itemsHtml = table.cart
          .map(
            (i) => `
                <tr>
                   <td class="py-1 break-words">${i.name}</td>
                   <td class="py-1 text-center whitespace-nowrap">x${i.qty}</td>
                   <td class="py-1 text-right whitespace-nowrap">$${(i.price * i.qty).toFixed(2)}</td>
                </tr>
             `,
          )
          .join("");
        document.getElementById("receipt-items").innerHTML = itemsHtml;
        document.getElementById("receipt-modal").classList.remove("hidden");
      }

      function closeReceiptModal() {
        document.getElementById("receipt-modal").classList.add("hidden");
        currentReceiptTable = null;
      }

      function processReceiptPayment() {
        if (!currentReceiptTable) return;
        const table = currentReceiptTable;

        const alreadyPaid = table.payRecords.reduce(
          (sum, record) => sum + record.amount,
          0,
        );
        const remaining = currentReceiptTotal - alreadyPaid;

        // Automatically assume exact amount tendered since the manual input field was removed
        table.payRecords.push({
          method: selectedPayment,
          amount: remaining,
          timestamp: new Date().toISOString(),
          user: currentUser.name,
        });

        // --- PRINT LOGIC ---
        const printableContent =
          document.getElementById("printable-receipt").innerHTML;

        const printWindow = window.open("", "_blank", "width=400,height=600");
        if (printWindow) {
          printWindow.document.write(`
                  <html>
                     <head>
                        <title>Receipt - Hudheel Bile</title>
                        <style>
                           body {
                              font-family: monospace;
                              font-size: 14px;
                              color: #000;
                              padding: 20px;
                              background: #fff;
                           }
                           .text-center { text-align: center; }
                           .mb-6 { margin-bottom: 24px; }
                           .mb-3 { margin-bottom: 12px; }
                           .mb-1 { margin-bottom: 4px; }
                           .mx-auto { margin-left: auto; margin-right: auto; }
                           .uppercase { text-transform: uppercase; }
                           .tracking-widest { letter-spacing: 0.1em; }
                           .text-2xl { font-size: 24px; }
                           .text-3xl { font-size: 30px; }
                           .text-xs { font-size: 12px; }
                           .text-lg { font-size: 18px; }
                           .font-black { font-weight: 900; }
                           .font-bold { font-weight: bold; }
                           .font-semibold { font-weight: 600; }
                           .flex { display: flex; }
                           .justify-between { justify-content: space-between; }
                           .flex-col { flex-direction: column; }
                           .gap-2 { gap: 8px; }
                           .border-b { border-bottom: 1px solid #ccc; }
                           .border-dashed { border-bottom-style: dashed; }
                           .pb-4 { padding-bottom: 16px; }
                           .pb-2 { padding-bottom: 8px; }
                           .mt-4 { margin-top: 16px; }
                           .mb-4 { margin-bottom: 16px; }
                           .mt-8 { margin-top: 32px; }
                           .w-full { width: 100%; }
                           .text-left { text-align: left; }
                           .text-right { text-align: right; }
                           .py-1 { padding-top: 4px; padding-bottom: 4px; }
                           .italic { font-style: italic; }
                           table { border-collapse: collapse; width: 100%; }
                           th, td { padding: 4px 0; }

                           /* Prevent SVGs (like FontAwesome logos) from blowing up in print mode */
                           svg, img {
                              width: 32px !important;
                              height: 32px !important;
                              margin: 0 auto;
                              display: block;
                           }

                           /* Hidden Leaf SVG backup if FA script fails to load in popup */
                           .fa-leaf::before {
                              content: "ðŸƒ";
                              font-size: 24px;
                              font-style: normal;
                           }
                        </style>
                     </head>
                     <body>
                        ${printableContent}
                        ${"<scr" + "ipt>"}
                           window.onload = function() {
                              setTimeout(function() {
                                 window.print();
                                 window.close();
                              }, 250);
                           };
                        ${"</scr" + "ipt>"}
      </body>

      </html>
      `);
          printWindow.document.close();
        }

        closeReceiptModal();

        table.timestamps.paid = new Date();
        releaseTableAndLog(table, currentReceiptTotal);
      }

      function releaseTableAndLog(table, totalAmount) {
        const assignedUserId = table.lockedBy;

        // 1. Move to history
        orderHistory.push({
          orderId:
            table.cart.length > 0
              ? table.cart[0].id + Math.floor(Math.random() * 1000)
              : Date.now(), // Fallback ID
          tableId: table.id,
          items: JSON.parse(JSON.stringify(table.cart)),
          total: totalAmount,
          payments: JSON.parse(JSON.stringify(table.payRecords)),
          waiter: table.waiterName,
          waiterId: assignedUserId,
          timestamps: table.timestamps,
        });

        console.log(
          "Order History Logged",
          orderHistory[orderHistory.length - 1],
        );

        // 2. Clear table
        table.cart = [];
        table.status = STATUS.AVAILABLE;
        table.name = "Available";
        table.lockedBy = null;
        table.waiterName = null;
        table.payRecords = [];

        showToast(t("toast_paid"), "success");
        saveData();

        if (!currentUser || currentUser.id === assignedUserId) {
          handleTableReleaseRedirect();
        } else {
          switchView("tables");
        }
      }

      function promptReopenTable(tableId) {
        if (!["Admin", "Manager"].includes(currentUser.role)) return;

        const recentOrderIndex = orderHistory
          .map((o) => o.tableId)
          .lastIndexOf(tableId);
        if (recentOrderIndex === -1) {
          showToast(t("toast_no_recent_orders"), "warning");
          return;
        }

        const orderToRestore = orderHistory[recentOrderIndex];
        // Check if it was closed within the last 2 hours to prevent crazy restoring
        const closeTime = orderToRestore.timestamps.paid
          ? new Date(orderToRestore.timestamps.paid).getTime()
          : 0;
        if (Date.now() - closeTime > 2 * 60 * 60 * 1000) {
          showToast(t("toast_order_too_old"), "error");
          return;
        }

        const confirmMsg = t("confirm_reopen")
          .replace("{id}", tableId)
          .replace("{total}", orderToRestore.total.toFixed(2));
        if (confirm(confirmMsg)) {
          const table = tables.find((t) => t.id === tableId);

          // Log the structural override
          auditLog.push({
            action: "REOPEN_TABLE",
            table: tableId,
            user: currentUser.name,
            reason: "Overrides paid status",
            timestamp: new Date().toISOString(),
          });

          table.cart = orderToRestore.items;
          table.payRecords = orderToRestore.payments;
          table.status = STATUS.WAITING_PAYMENT; // Put back to payment screen
          table.lockedBy = currentUser.id;
          table.waiterName = currentUser.name;
          table.name = orderToRestore.waiter + " (Reopened)";
          table.timestamps = orderToRestore.timestamps;

          // Remove from history so it doesn't double-count later
          orderHistory.splice(recentOrderIndex, 1);

          showToast(
            t("toast_table_restored").replace("{id}", tableId),
            "success",
          );
          saveData();
          renderTablesView(); // Refresh visual
          openTable(tableId); // Focus it
        }
      }

      // --- KITCHEN LOGIC ---
      function renderKitchen() {
        const grid = document.getElementById("kitchen-grid");
        const empty = document.getElementById("kitchen-empty");
        if (!grid) return;

        if (kitchenOrders.length === 0) {
          grid.innerHTML = "";
          empty.classList.remove("hidden");
          return;
        }
        empty.classList.add("hidden");

        grid.innerHTML = kitchenOrders
          .map((order) => {
            const isNew = order.status === "new";

            // Match table card color scheme exactly
            // new (SENT) â†’ purple-to-indigo | preparing â†’ green-to-emerald
            const cardGradient = isNew
              ? "bg-gradient-to-br from-purple-500 to-indigo-500"
              : "bg-gradient-to-br from-green-500 to-emerald-500";
            const cardShadow = isNew
              ? "shadow-[0_10px_30px_rgba(168,85,247,0.4)] hover:shadow-[0_16px_40px_rgba(168,85,247,0.55)]"
              : "shadow-[0_10px_30px_rgba(16,185,129,0.4)] hover:shadow-[0_16px_40px_rgba(16,185,129,0.55)]";

            // Badge â€” white glass pill (same as table status badge)
            const badgeLabel = isNew
              ? t("kitchen_sent")
              : t("kitchen_preparing");

            // Glow blob
            const glowColor = isNew ? "#a855f7" : "#10b981";

            // Button â€” white glass style, matches interior of gradient cards
            const btnAction = isNew
              ? `<i class="fa-solid fa-fire-burner mr-2"></i> ${t("kitchen_start")}`
              : `<i class="fa-solid fa-bell mr-2"></i> ${t("kitchen_mark_ready")}`;
            const nextStatus = isNew ? "preparing" : "ready";

            return `
              <div class="group ${cardGradient} rounded-3xl overflow-hidden flex flex-col relative transition-all duration-500 hover:-translate-y-2 ${cardShadow} cursor-default">

                <!--Glow blob-->
                <div
                  class="absolute -top-6 -right-6 w-32 h-32 rounded-full opacity-20 blur-2xl pointer-events-none transition-opacity duration-300 group-hover:opacity-40"
                  style="background: radial-gradient(circle, ${glowColor}, transparent 70%);"></div>

                <!--Header -->
                <div class="p-5 flex justify-between items-start relative z-10">
                  <div>
                    <div class="flex items-center gap-2 mb-1">
                      <h3 class="font-black text-2xl text-white tracking-tight">${order.tableId}</h3>
                      <span class="text-xs text-white/50 font-bold mt-1">#${order.id}</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-white/70">
                      <i class="fa-regular fa-clock text-[10px]"></i>
                      <span>${order.time}</span>
                      <span class="text-white/30">|</span>
                      <i class="fa-solid fa-user text-[10px]"></i>
                      <span>${order.waiterName.split(" ")[0]}</span>
                    </div>
                  </div>
                  <span
                    class="flex items-center gap-1.5 bg-white/20 border border-white/30 backdrop-blur-sm px-3 py-1.5 rounded-full text-[11px] font-extrabold uppercase tracking-wider text-white shadow-inner">
                    <span class="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>
                    ${badgeLabel}
                  </span>
                </div>

                <!--Divider -->
                <div class="mx-5 border-t border-white/15"></div>

                <!--Items -->
                <div class="p-5 flex-1 space-y-2.5 relative z-10">
                  ${order.items
                    .map(
                      (i) => `
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-white/90 font-semibold">${i.name}</span>
                    <span
                      class="text-xs font-black text-white bg-white/20 border border-white/20 px-2.5 py-1 rounded-xl">Ã—${i.qty}</span>
                  </div>
                  `,
                    )
                    .join("")}
                </div>

                <!--Action Button-->
                <div class="p-4 pt-0 relative z-10">
                  <button onclick="updateKitchenStatus(${order.id}, '${nextStatus}')"
                    class="w-full py-3.5 rounded-2xl bg-black/20 hover:bg-black/30 border border-white/20 text-white font-black text-sm uppercase tracking-wide transition-all duration-300 hover:shadow-xl active:scale-95 hover:-translate-y-0.5 backdrop-blur-sm">
                    ${btnAction}
                  </button>
                </div>
              </div>
              `;
          })
          .join("");
      }

      function updateKitchenStatus(orderId, nextStatus) {
        // Let the Mac handle the logic so all tablets stay perfectly synced
        socket.emit("update_kitchen_status", {
          orderId: orderId,
          nextStatus: nextStatus,
        });
      }

      // --- NOTIFICATION SYSTEM ---
      function checkPendingNotifications() {
        if (!currentUser) return;

        const userNotifs = pendingNotifications.filter(
          (n) =>
            n.targetUserId === currentUser.id || currentUser.role === "Admin",
        );

        if (userNotifs.length > 0) {
          userNotifs.forEach((n, idx) => {
            setTimeout(() => {
              showToast(n.message, "info");
            }, idx * 1500);
          });
          pendingNotifications = pendingNotifications.filter(
            (n) =>
              n.targetUserId !== currentUser.id && currentUser.role !== "Admin",
          );
          renderTablesView();
        }
      }

      setInterval(checkPendingNotifications, 3000);

      let _toastTimer = null;

      function showToast(msg, type = "success") {
        const toast = document.getElementById("toast");
        const icon = document.getElementById("toast-icon");
        const title = document.getElementById("toast-title");

        document.getElementById("toast-msg").innerText = msg;

        if (type === "success") {
          icon.className =
            "fa-solid fa-circle-check text-primary text-xl flex-shrink-0";
          title.innerText = t("toast_title_success");
        } else if (type === "error") {
          icon.className =
            "fa-solid fa-circle-exclamation text-red-500 text-xl flex-shrink-0";
          title.innerText = t("toast_title_error");
        } else if (type === "info") {
          icon.className =
            "fa-solid fa-bell text-blue-500 text-xl flex-shrink-0";
          title.innerText = t("toast_title_info");
        } else if (type === "warning") {
          icon.className =
            "fa-solid fa-triangle-exclamation text-orange-500 text-xl flex-shrink-0";
          title.innerText = t("toast_title_warning");
        }

        // Cancel any existing timer then show
        if (_toastTimer) clearTimeout(_toastTimer);
        toast.classList.remove(
          "translate-y-[-100px]",
          "md:translate-x-40",
          "opacity-0",
          "pointer-events-none",
        );
        toast.classList.add("pointer-events-auto");
        _toastTimer = setTimeout(() => dismissToast(), 4000);
      }

      function dismissToast() {
        const toast = document.getElementById("toast");
        if (_toastTimer) {
          clearTimeout(_toastTimer);
          _toastTimer = null;
        }
        toast.classList.add(
          "translate-y-[-100px]",
          "md:translate-x-40",
          "opacity-0",
          "pointer-events-none",
        );
        toast.classList.remove("pointer-events-auto");
      }

      // --- TABLE RELEASE REDIRECT LOGIC ---
      function handleTableReleaseRedirect(forceLogin = false) {
        if (!currentUser || forceLogin) {
          window.postLoginRedirect = "tables";
          document.getElementById("login-screen").classList.remove("hidden");
          document.getElementById("app-container").classList.add("hidden");
          activeTableId = null;
        } else {
          switchView("tables");
        }
      }

      window.addEventListener("storage", (e) => {
        if (e.key === "pos_tables") {
          const oldTables = JSON.parse(e.oldValue || "[]");
          const newTables = JSON.parse(e.newValue || "[]");

          oldTables.forEach((oldT) => {
            if (oldT.status !== STATUS.AVAILABLE) {
              const newT = newTables.find((t) => t.id === oldT.id);
              if (newT && newT.status === STATUS.AVAILABLE) {
                // Table was released
                if (currentUser && currentUser.id === oldT.lockedBy) {
                  showToast(t("toast_remote_release"), "info");
                  handleTableReleaseRedirect();
                } else if (!currentUser) {
                  const lastUserId = localStorage.getItem("lastLoggedInUserId");
                  if (lastUserId && parseInt(lastUserId) === oldT.lockedBy) {
                    handleTableReleaseRedirect(true);
                  }
                }
              }
            }
          });
        }
      });

      // --- TABLE RELEASE MODAL HELPERS (see HTML modal below) ---
    </script>

    <!-- RELEASE TABLE CONFIRMATION MODAL -->
    <div
      id="release-table-modal"
      class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center backdrop-blur-sm p-4"
    >
      <div
        id="release-modal-content"
        class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 border border-gray-100 dark:border-gray-700"
      >
        <!-- Accent Header -->
        <div
          class="bg-gradient-to-br from-primary to-emerald-700 px-7 pt-7 pb-10 relative overflow-hidden"
        >
          <div
            class="absolute -top-6 -right-6 w-28 h-28 bg-white/10 rounded-full"
          ></div>
          <div
            class="absolute -bottom-4 -left-4 w-20 h-20 bg-white/10 rounded-full"
          ></div>
          <div class="flex justify-between items-start relative z-10">
            <div>
              <div
                class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3"
              >
                <i class="fa-solid fa-door-open text-white text-lg"></i>
              </div>
              <h2
                class="text-2xl font-extrabold text-white"
                data-i18n="release_title"
              >
                Release Table
              </h2>
              <p
                class="text-white/80 text-sm mt-1"
                data-i18n="release_confirm_msg"
              >
                Are you sure you want to release this table?
              </p>
            </div>
            <button
              onclick="closeReleaseModal()"
              class="w-9 h-9 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-colors"
            >
              <i class="fa-solid fa-xmark text-lg"></i>
            </button>
          </div>
        </div>

        <!-- Body -->
        <div
          class="-mt-6 bg-white dark:bg-gray-900 rounded-t-[2rem] px-7 pt-6 pb-7 space-y-5"
        >
          <!-- Warning note -->
          <div
            class="flex items-start gap-3 bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800/40 rounded-2xl p-4"
          >
            <i
              class="fa-solid fa-triangle-exclamation text-green-500 mt-0.5 flex-shrink-0"
            ></i>
            <p
              class="text-sm text-green-700 dark:text-green-300 font-semibold leading-snug"
              data-i18n="release_confirm_sub"
            >
              Unsaved items will be lost.
            </p>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-3">
            <button
              onclick="closeReleaseModal()"
              class="flex-1 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-sm flex items-center justify-center gap-2"
            >
              <i class="fa-solid fa-arrow-left text-xs"></i>
              <span data-i18n="release_keep">Keep Table</span>
            </button>
            <button
              onclick="confirmReleaseTable()"
              class="flex-1 py-3.5 rounded-xl bg-primary hover:bg-emerald-600 text-white font-bold shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all active:scale-95 text-sm flex items-center justify-center gap-2"
            >
              <i class="fa-solid fa-door-open"></i>
              <span data-i18n="release_yes">Yes, Release</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
